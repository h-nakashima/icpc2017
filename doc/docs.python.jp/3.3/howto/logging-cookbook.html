<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Logging クックブック &mdash; Python 3.3.6 ドキュメント</title>
    
    <link rel="stylesheet" href="../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.3.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Python 3.3.6 ドキュメント 内を検索"
          href="../_static/opensearch.xml"/>
    <link rel="author" title="このドキュメントについて" href="../about.html" />
    <link rel="copyright" title="著作権" href="../copyright.html" />
    <link rel="top" title="Python 3.3.6 ドキュメント" href="../contents.html" />
    <link rel="up" title="Python HOWTO" href="index.html" />
    <link rel="next" title="正規表現 HOWTO" href="regex.html" />
    <link rel="prev" title="Logging HOWTO" href="logging.html" />
    <link rel="shortcut icon" type="image/png" href="../_static/py.png" />
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    <script type="text/javascript" src="../_static/_jp.js"></script>
    <script type="text/javascript" src="../_static/version_switch.js"></script>
    
 

  <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-34175846-1', 'python.jp');
        ga('send', 'pageview');

      </script>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="regex.html" title="正規表現 HOWTO"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="logging.html" title="Logging HOWTO"
             accesskey="P">前へ</a> |</li>
        <li><img src="../_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="http://www.python.org/">Python</a> &raquo;</li>
        <li>
          <span class="version_switcher_placeholder">3.3.6</span>
          <a href="../index.html">Documentation</a> &raquo;
        </li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Python HOWTO</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="logging-cookbook">
<span id="id1"></span><h1>Logging クックブック<a class="headerlink" href="#logging-cookbook" title="このヘッドラインへのパーマリンク">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Vinay Sajip &lt;vinay_sajip at red-dove dot com&gt;</td>
</tr>
</tbody>
</table>
<p>このページでは、過去に見つかった logging に関するいくつかの便利なレシピを紹介します。</p>
<div class="section" id="using-logging-in-multiple-modules">
<h2>複数のモジュールで logging を使う<a class="headerlink" href="#using-logging-in-multiple-modules" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="docutils literal"><span class="pre">logging.getLogger('someLogger')</span></code> の複数回の呼び出しは同じ logger への参照を返します。これは同じ Python インタプリタプロセス上で動いている限り、一つのモジュールの中からに限らず、モジュールをまたいでも当てはまります。同じオブジェクトへの参照という点でも正しいです。
さらに、一つのモジュールの中で親 logger を定義して設定し、別のモジュールで子 logger を定義する (ただし設定はしない) ことが可能で、すべての子 logger への呼び出しは親にまで渡されます。まずはメインのモジュールです:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">auxiliary_module</span>

<span class="c"># create logger with &#39;spam_application&#39;</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;spam_application&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="c"># create file handler which logs even debug messages</span>
<span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s">&#39;spam.log&#39;</span><span class="p">)</span>
<span class="n">fh</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="c"># create console handler with a higher log level</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="c"># create formatter and add it to the handlers</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#39;</span><span class="p">)</span>
<span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="c"># add the handlers to the logger</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;creating an instance of auxiliary_module.Auxiliary&#39;</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">auxiliary_module</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;created an instance of auxiliary_module.Auxiliary&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;calling auxiliary_module.Auxiliary.do_something&#39;</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">do_something</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;finished auxiliary_module.Auxiliary.do_something&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;calling auxiliary_module.some_function()&#39;</span><span class="p">)</span>
<span class="n">auxiliary_module</span><span class="o">.</span><span class="n">some_function</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;done with auxiliary_module.some_function()&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>そして補助モジュール (auxiliary module) がこちらです:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>

<span class="c"># create logger</span>
<span class="n">module_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;spam_application.auxiliary&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Auxiliary</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;spam_application.auxiliary.Auxiliary&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;creating an instance of Auxiliary&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;doing something&#39;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;done doing something&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">some_function</span><span class="p">():</span>
    <span class="n">module_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;received a call to &quot;some_function&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>出力はこのようになります:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="mi">2005</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">23</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">663</span> <span class="o">-</span> <span class="n">spam_application</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span>
   <span class="n">creating</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">auxiliary_module</span><span class="o">.</span><span class="n">Auxiliary</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">23</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">665</span> <span class="o">-</span> <span class="n">spam_application</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">Auxiliary</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span>
   <span class="n">creating</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">Auxiliary</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">23</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">665</span> <span class="o">-</span> <span class="n">spam_application</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span>
   <span class="n">created</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">auxiliary_module</span><span class="o">.</span><span class="n">Auxiliary</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">23</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">668</span> <span class="o">-</span> <span class="n">spam_application</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span>
   <span class="n">calling</span> <span class="n">auxiliary_module</span><span class="o">.</span><span class="n">Auxiliary</span><span class="o">.</span><span class="n">do_something</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">23</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">668</span> <span class="o">-</span> <span class="n">spam_application</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">Auxiliary</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span>
   <span class="n">doing</span> <span class="n">something</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">23</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">669</span> <span class="o">-</span> <span class="n">spam_application</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">Auxiliary</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span>
   <span class="n">done</span> <span class="n">doing</span> <span class="n">something</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">23</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">670</span> <span class="o">-</span> <span class="n">spam_application</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span>
   <span class="n">finished</span> <span class="n">auxiliary_module</span><span class="o">.</span><span class="n">Auxiliary</span><span class="o">.</span><span class="n">do_something</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">23</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">671</span> <span class="o">-</span> <span class="n">spam_application</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span>
   <span class="n">calling</span> <span class="n">auxiliary_module</span><span class="o">.</span><span class="n">some_function</span><span class="p">()</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">23</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">672</span> <span class="o">-</span> <span class="n">spam_application</span><span class="o">.</span><span class="n">auxiliary</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span>
   <span class="n">received</span> <span class="n">a</span> <span class="n">call</span> <span class="n">to</span> <span class="s">&#39;some_function&#39;</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">23</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">673</span> <span class="o">-</span> <span class="n">spam_application</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span>
   <span class="n">done</span> <span class="k">with</span> <span class="n">auxiliary_module</span><span class="o">.</span><span class="n">some_function</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-handlers-and-formatters">
<h2>複数の handler と formatter<a class="headerlink" href="#multiple-handlers-and-formatters" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>logger は通常の Python オブジェクトです。 <a class="reference internal" href="../library/logging.html#logging.Logger.addHandler" title="logging.Logger.addHandler"><code class="xref py py-meth docutils literal"><span class="pre">addHandler()</span></code></a> メソッドは追加されるハンドラの個数について最小値も最大値も定めていません。 時にアプリケーションがすべての深刻度のすべてのメッセージをテキストファイルに記録しつつ、 同時にエラーやそれ以上のものをコンソールに出力することが役に立ちます。 これを実現する方法は、単に適切なハンドラを設定するだけです。 アプリケーションコードの中のログ記録の呼び出しは変更されずに残ります。 少し前に取り上げた単純なモジュール式の例を少し変えるとこうなります:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;simple_example&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="c"># create file handler which logs even debug messages</span>
<span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s">&#39;spam.log&#39;</span><span class="p">)</span>
<span class="n">fh</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="c"># create console handler with a higher log level</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="c"># create formatter and add it to the handlers</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#39;</span><span class="p">)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="c"># add the handlers to logger</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

<span class="c"># &#39;application&#39; code</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;debug message&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;info message&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;warn message&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;error message&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;critical message&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>&#8216;application&#8217; 部分のコードは複数の handler について何も気にしていないことに注目してください。
変更した箇所は新しい <em>fh</em> という名の handler を追加して設定したところがすべてです。</p>
<p>新しい handler を、異なる深刻度に対する filter と共に生成できることは、アプリケーションを書いてテストを行うときとても助けになります。
デバッグ用にたくさんの <code class="docutils literal"><span class="pre">print</span></code> 文を使う代わりに <code class="docutils literal"><span class="pre">logger.debug</span></code> を使いましょう。あとで消したりコメントアウトしたりしなければならない print 文と違って、 logger.debug 命令はソースコードの中にそのまま残しておいて再び必要になるまで休眠させておけます。その時必要になるのはただ logger および/または handler の深刻度の設定をいじることだけです。</p>
</div>
<div class="section" id="logging-to-multiple-destinations">
<span id="multiple-destinations"></span><h2>複数の出力先にログを出力する<a class="headerlink" href="#logging-to-multiple-destinations" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>コンソールとファイルに、別々のメッセージ書式で、別々の状況に応じたログ出力を行わせたいとしましょう。例えば DEBUG よりも高いレベルのメッセージはファイルに記録し、 INFO 以上のレベルのメッセージはコンソールに出力したいという場合です。また、ファイルにはタイムスタンプを記録し、コンソールには出力しないとします。以下のようにすれば、こうした挙動を実現できます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>

<span class="c"># set up logging to file - see previous section for more details</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s">&#39;%(asctime)s %(name)-12s %(levelname)-8s %(message)s&#39;</span><span class="p">,</span>
                    <span class="n">datefmt</span><span class="o">=</span><span class="s">&#39;%m-%d %H:%M&#39;</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="s">&#39;/temp/myapp.log&#39;</span><span class="p">,</span>
                    <span class="n">filemode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
<span class="c"># define a Handler which writes INFO messages or higher to the sys.stderr</span>
<span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">console</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="c"># set a format which is simpler for console use</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;%(name)-12s: %(levelname)-8s %(message)s&#39;</span><span class="p">)</span>
<span class="c"># tell the handler to use this format</span>
<span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="c"># add the handler to the root logger</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>

<span class="c"># Now, we can log to the root logger, or any other logger. First the root...</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Jackdaws love my big sphinx of quartz.&#39;</span><span class="p">)</span>

<span class="c"># Now, define a couple of other loggers which might represent areas in your</span>
<span class="c"># application:</span>

<span class="n">logger1</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;myapp.area1&#39;</span><span class="p">)</span>
<span class="n">logger2</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;myapp.area2&#39;</span><span class="p">)</span>

<span class="n">logger1</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Quick zephyrs blow, vexing daft Jim.&#39;</span><span class="p">)</span>
<span class="n">logger1</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;How quickly daft jumping zebras vex.&#39;</span><span class="p">)</span>
<span class="n">logger2</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Jail zesty vixen who grabbed pay from quack.&#39;</span><span class="p">)</span>
<span class="n">logger2</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;The five boxing wizards jump quickly.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>このスクリプトを実行すると、コンソールには以下のように表示されるでしょう:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">root</span>        <span class="p">:</span> <span class="n">INFO</span>     <span class="n">Jackdaws</span> <span class="n">love</span> <span class="n">my</span> <span class="n">big</span> <span class="n">sphinx</span> <span class="n">of</span> <span class="n">quartz</span><span class="o">.</span>
<span class="n">myapp</span><span class="o">.</span><span class="n">area1</span> <span class="p">:</span> <span class="n">INFO</span>     <span class="n">How</span> <span class="n">quickly</span> <span class="n">daft</span> <span class="n">jumping</span> <span class="n">zebras</span> <span class="n">vex</span><span class="o">.</span>
<span class="n">myapp</span><span class="o">.</span><span class="n">area2</span> <span class="p">:</span> <span class="n">WARNING</span>  <span class="n">Jail</span> <span class="n">zesty</span> <span class="n">vixen</span> <span class="n">who</span> <span class="n">grabbed</span> <span class="n">pay</span> <span class="kn">from</span> <span class="nn">quack.</span>
<span class="n">myapp</span><span class="o">.</span><span class="n">area2</span> <span class="p">:</span> <span class="n">ERROR</span>    <span class="n">The</span> <span class="n">five</span> <span class="n">boxing</span> <span class="n">wizards</span> <span class="n">jump</span> <span class="n">quickly</span><span class="o">.</span>
</pre></div>
</div>
<p>そして、ファイルは以下のようになるはずです:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="mi">10</span><span class="o">-</span><span class="mi">22</span> <span class="mi">22</span><span class="p">:</span><span class="mi">19</span> <span class="n">root</span>         <span class="n">INFO</span>     <span class="n">Jackdaws</span> <span class="n">love</span> <span class="n">my</span> <span class="n">big</span> <span class="n">sphinx</span> <span class="n">of</span> <span class="n">quartz</span><span class="o">.</span>
<span class="mi">10</span><span class="o">-</span><span class="mi">22</span> <span class="mi">22</span><span class="p">:</span><span class="mi">19</span> <span class="n">myapp</span><span class="o">.</span><span class="n">area1</span>  <span class="n">DEBUG</span>    <span class="n">Quick</span> <span class="n">zephyrs</span> <span class="n">blow</span><span class="p">,</span> <span class="n">vexing</span> <span class="n">daft</span> <span class="n">Jim</span><span class="o">.</span>
<span class="mi">10</span><span class="o">-</span><span class="mi">22</span> <span class="mi">22</span><span class="p">:</span><span class="mi">19</span> <span class="n">myapp</span><span class="o">.</span><span class="n">area1</span>  <span class="n">INFO</span>     <span class="n">How</span> <span class="n">quickly</span> <span class="n">daft</span> <span class="n">jumping</span> <span class="n">zebras</span> <span class="n">vex</span><span class="o">.</span>
<span class="mi">10</span><span class="o">-</span><span class="mi">22</span> <span class="mi">22</span><span class="p">:</span><span class="mi">19</span> <span class="n">myapp</span><span class="o">.</span><span class="n">area2</span>  <span class="n">WARNING</span>  <span class="n">Jail</span> <span class="n">zesty</span> <span class="n">vixen</span> <span class="n">who</span> <span class="n">grabbed</span> <span class="n">pay</span> <span class="kn">from</span> <span class="nn">quack.</span>
<span class="mi">10</span><span class="o">-</span><span class="mi">22</span> <span class="mi">22</span><span class="p">:</span><span class="mi">19</span> <span class="n">myapp</span><span class="o">.</span><span class="n">area2</span>  <span class="n">ERROR</span>    <span class="n">The</span> <span class="n">five</span> <span class="n">boxing</span> <span class="n">wizards</span> <span class="n">jump</span> <span class="n">quickly</span><span class="o">.</span>
</pre></div>
</div>
<p>これを見て分かる通り、 DEBUG メッセージはファイルだけに出力され、その他のメッセージは両方に出力されます。</p>
<p>この例ではコンソールとファイルのハンドラだけを使っていますが、実際には任意の数のハンドラや組み合わせを使えます。</p>
</div>
<div class="section" id="configuration-server-example">
<h2>設定サーバの例<a class="headerlink" href="#configuration-server-example" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ログ記録設定サーバを使うモジュールの例です:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.config</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c"># read initial config file</span>
<span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fileConfig</span><span class="p">(</span><span class="s">&#39;logging.conf&#39;</span><span class="p">)</span>

<span class="c"># create and start listener on port 9999</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;simpleExample&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># loop through logging calls to see the difference</span>
    <span class="c"># new configurations make, until Ctrl+C is pressed</span>
    <span class="k">while</span> <span class="k">True</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;debug message&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;info message&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;warn message&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;error message&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;critical message&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="c"># cleanup</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stopListening</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>そしてファイル名を受け取ってそのファイルをサーバに送るスクリプトですが、それに先だってバイナリエンコード長を新しいログ記録の設定として先に送っておきます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">struct</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data_to_send</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s">&#39;localhost&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">9999</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s">&#39;connecting...&#39;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s">&#39;sending config...&#39;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&gt;L&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_to_send</span><span class="p">)))</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data_to_send</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s">&#39;complete&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="dealing-with-handlers-that-block">
<h2>ブロックする handler を扱う<a class="headerlink" href="#dealing-with-handlers-that-block" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ときどき、 logging を行っているスレッドをブロックせずに、 handler が動くようにしないといけないときがあります。
これは Web アプリケーションではよくあることですし、もちろん他のシナリオでも起きる話です。</p>
<p>動作が鈍くなるときの元凶はたいてい、開発者のコントロール外にあるいくつもの理由で (例えば、残念なパフォーマンスのメールやネットワークのインフラ) 、
<a class="reference internal" href="../library/logging.handlers.html#logging.handlers.SMTPHandler" title="logging.handlers.SMTPHandler"><code class="xref py py-class docutils literal"><span class="pre">SMTPHandler</span></code></a>: が電子メールを送るのに時間がかかることです。
しかし、ほとんどのネットワークをまたぐ handler はブロックする可能性があります:
<a class="reference internal" href="../library/logging.handlers.html#logging.handlers.SocketHandler" title="logging.handlers.SocketHandler"><code class="xref py py-class docutils literal"><span class="pre">SocketHandler</span></code></a> による処理でさえ、裏で DNS への問い合わせというとても遅い処理を行うことがあります
(そしてこの問い合わせ処理は、 Python の層より下のあなたの手の届かない、ソケットライブラリの深いところにある可能性もあります)。</p>
<p>解決策の1つは、2パートに分離したアプローチを用いることです。
最初のパートは、パフォーマンスが重要なスレッドからアクセスされる、 <a class="reference internal" href="../library/logging.handlers.html#logging.handlers.QueueHandler" title="logging.handlers.QueueHandler"><code class="xref py py-class docutils literal"><span class="pre">QueueHandler</span></code></a> だけをアタッチした logger です。
この logger は単に、十分大きい、あるいは無制限の容量を持ったキューに書き込むだけです。
キューへの書き込みは通常すぐに完了しますが、念の為に <a class="reference internal" href="../library/queue.html#queue.Full" title="queue.Full"><code class="xref py py-exc docutils literal"><span class="pre">queue.Full</span></code></a> 例外をキャッチする必要があるかもしれません。
もしパフォーマンスクリティカルなスレッドを持つライブラリの開発者であるなら、このことを (<code class="docutils literal"><span class="pre">QueueHandler</span></code> だけをアタッチした logger についての言及を添えて) ドキュメントに書いておきましょう。</p>
<p>2つ目のパートは <a class="reference internal" href="../library/logging.handlers.html#logging.handlers.QueueHandler" title="logging.handlers.QueueHandler"><code class="xref py py-class docutils literal"><span class="pre">QueueHandler</span></code></a> の対向として作られた <a class="reference internal" href="../library/logging.handlers.html#logging.handlers.QueueListener" title="logging.handlers.QueueListener"><code class="xref py py-class docutils literal"><span class="pre">QueueListener</span></code></a> です。
<a class="reference internal" href="../library/logging.handlers.html#logging.handlers.QueueListener" title="logging.handlers.QueueListener"><code class="xref py py-class docutils literal"><span class="pre">QueueListener</span></code></a> はとてもシンプルで、キューと handler を渡され、内部で <code class="docutils literal"><span class="pre">QueueHandler</span></code> (もしくは他の <code class="docutils literal"><span class="pre">LogRecord</span></code> の出力元) から送られた LogRecord をキューから受け取るスレッドを起動します。
<code class="docutils literal"><span class="pre">LogRecord</span></code> をキューから取り出して、 handler に渡して処理させます。</p>
<p>分離した <a class="reference internal" href="../library/logging.handlers.html#logging.handlers.QueueListener" title="logging.handlers.QueueListener"><code class="xref py py-class docutils literal"><span class="pre">QueueListener</span></code></a> クラスを持つメリットは、複数の <code class="docutils literal"><span class="pre">QueueHandler</span></code> に対して1つのインスタンスで logging できることです。
既存の handler のスレッド利用版を使って handler ごとにスレッドを持つよりはずっとリソースにやさしくなります。</p>
<p>この2つのクラスを利用する例です (import は省略):</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">que</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c"># no limit on size</span>
<span class="n">queue_handler</span> <span class="o">=</span> <span class="n">QueueHandler</span><span class="p">(</span><span class="n">que</span><span class="p">)</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">listener</span> <span class="o">=</span> <span class="n">QueueListener</span><span class="p">(</span><span class="n">que</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">root</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">queue_handler</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;%(threadName)s: %(message)s&#39;</span><span class="p">)</span>
<span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">listener</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="c"># The log output will display the thread which generated</span>
<span class="c"># the event (the main thread) rather than the internal</span>
<span class="c"># thread which monitors the internal queue. This is what</span>
<span class="c"># you want to happen.</span>
<span class="n">root</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Look out!&#39;</span><span class="p">)</span>
<span class="n">listener</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>実行すると次のように出力します:</p>
<div class="highlight-python3"><div class="highlight"><pre>MainThread: Look out!
</pre></div>
</div>
</div>
<div class="section" id="sending-and-receiving-logging-events-across-a-network">
<span id="network-logging"></span><h2>ネットワーク越しの logging イベントの送受信<a class="headerlink" href="#sending-and-receiving-logging-events-across-a-network" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ログイベントをネットワーク越しに送信し、受信端でそれを処理したいとしましょう。 <a class="reference internal" href="../library/logging.handlers.html#logging.handlers.SocketHandler" title="logging.handlers.SocketHandler"><code class="xref py py-class docutils literal"><span class="pre">SocketHandler</span></code></a> インスタンスを送信端の root logger にアタッチすれば、簡単に実現できます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">logging.handlers</span>

<span class="n">rootLogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="n">rootLogger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">socketHandler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">SocketHandler</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">DEFAULT_TCP_LOGGING_PORT</span><span class="p">)</span>
<span class="c"># don&#39;t bother with a formatter, since a socket handler sends the event as</span>
<span class="c"># an unformatted pickle</span>
<span class="n">rootLogger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">socketHandler</span><span class="p">)</span>

<span class="c"># Now, we can log to the root logger, or any other logger. First the root...</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Jackdaws love my big sphinx of quartz.&#39;</span><span class="p">)</span>

<span class="c"># Now, define a couple of other loggers which might represent areas in your</span>
<span class="c"># application:</span>

<span class="n">logger1</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;myapp.area1&#39;</span><span class="p">)</span>
<span class="n">logger2</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;myapp.area2&#39;</span><span class="p">)</span>

<span class="n">logger1</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Quick zephyrs blow, vexing daft Jim.&#39;</span><span class="p">)</span>
<span class="n">logger1</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;How quickly daft jumping zebras vex.&#39;</span><span class="p">)</span>
<span class="n">logger2</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Jail zesty vixen who grabbed pay from quack.&#39;</span><span class="p">)</span>
<span class="n">logger2</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;The five boxing wizards jump quickly.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>受信端では <a class="reference internal" href="../library/socketserver.html#module-socketserver" title="socketserver: A framework for network servers."><code class="xref py py-mod docutils literal"><span class="pre">socketserver</span></code></a> モジュールを使って受信プログラムを作成しておきます。簡単な実用プログラムを以下に示します:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">socketserver</span>
<span class="kn">import</span> <span class="nn">struct</span>


<span class="k">class</span> <span class="nc">LogRecordStreamHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">StreamRequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handler for a streaming logging request.</span>

<span class="sd">    This basically logs the record using whatever logging policy is</span>
<span class="sd">    configured locally.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle multiple requests - each expected to be a 4-byte length,</span>
<span class="sd">        followed by the LogRecord in pickle format. Logs the record</span>
<span class="sd">        according to whatever policy is configured locally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="k">True</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">slen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;L&#39;</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">slen</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">slen</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">slen</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unPickle</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">makeLogRecord</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handleLogRecord</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unPickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handleLogRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="c"># if a name is specified, we use the named logger rather than the one</span>
        <span class="c"># implied by the record.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">logname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">logname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c"># N.B. EVERY record gets logged. This is because Logger.handle</span>
        <span class="c"># is normally called AFTER logger-level filtering. If you want</span>
        <span class="c"># to do filtering, do it at the client end to save wasting</span>
        <span class="c"># cycles and network bandwidth!</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LogRecordSocketReceiver</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingTCPServer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple TCP socket-based logging receiver suitable for testing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span>
                 <span class="n">port</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">DEFAULT_TCP_LOGGING_PORT</span><span class="p">,</span>
                 <span class="n">handler</span><span class="o">=</span><span class="n">LogRecordStreamHandler</span><span class="p">):</span>
        <span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingTCPServer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logname</span> <span class="o">=</span> <span class="k">None</span>

    <span class="k">def</span> <span class="nf">serve_until_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">select</span>
        <span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">abort</span><span class="p">:</span>
            <span class="n">rd</span><span class="p">,</span> <span class="n">wr</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">fileno</span><span class="p">()],</span>
                                       <span class="p">[],</span> <span class="p">[],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">()</span>
            <span class="n">abort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="nb">format</span><span class="o">=</span><span class="s">&#39;%(relativeCreated)5d %(name)-15s %(levelname)-8s %(message)s&#39;</span><span class="p">)</span>
    <span class="n">tcpserver</span> <span class="o">=</span> <span class="n">LogRecordSocketReceiver</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s">&#39;About to start TCP server...&#39;</span><span class="p">)</span>
    <span class="n">tcpserver</span><span class="o">.</span><span class="n">serve_until_stopped</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>先にサーバを起動しておき、次にクライアントを起動します。クライアント側では、コンソールには何も出力されません; サーバ側では以下のようなメッセージを目にするはずです:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">About</span> <span class="n">to</span> <span class="n">start</span> <span class="n">TCP</span> <span class="n">server</span><span class="o">...</span>
   <span class="mi">59</span> <span class="n">root</span>            <span class="n">INFO</span>     <span class="n">Jackdaws</span> <span class="n">love</span> <span class="n">my</span> <span class="n">big</span> <span class="n">sphinx</span> <span class="n">of</span> <span class="n">quartz</span><span class="o">.</span>
   <span class="mi">59</span> <span class="n">myapp</span><span class="o">.</span><span class="n">area1</span>     <span class="n">DEBUG</span>    <span class="n">Quick</span> <span class="n">zephyrs</span> <span class="n">blow</span><span class="p">,</span> <span class="n">vexing</span> <span class="n">daft</span> <span class="n">Jim</span><span class="o">.</span>
   <span class="mi">69</span> <span class="n">myapp</span><span class="o">.</span><span class="n">area1</span>     <span class="n">INFO</span>     <span class="n">How</span> <span class="n">quickly</span> <span class="n">daft</span> <span class="n">jumping</span> <span class="n">zebras</span> <span class="n">vex</span><span class="o">.</span>
   <span class="mi">69</span> <span class="n">myapp</span><span class="o">.</span><span class="n">area2</span>     <span class="n">WARNING</span>  <span class="n">Jail</span> <span class="n">zesty</span> <span class="n">vixen</span> <span class="n">who</span> <span class="n">grabbed</span> <span class="n">pay</span> <span class="kn">from</span> <span class="nn">quack.</span>
   <span class="mi">69</span> <span class="n">myapp</span><span class="o">.</span><span class="n">area2</span>     <span class="n">ERROR</span>    <span class="n">The</span> <span class="n">five</span> <span class="n">boxing</span> <span class="n">wizards</span> <span class="n">jump</span> <span class="n">quickly</span><span class="o">.</span>
</pre></div>
</div>
<p>特定のシナリオでは pickle にはいくつかのセキュリティ上の問題があることに注意してください。 これが問題になる場合、 <code class="xref py py-meth docutils literal"><span class="pre">makePickle()</span></code> メソッドをオーバーライドして代替手段を実装することで 異なるシリアライズ手法を使用できます。 代替シリアライズ手法を使うように上記のスクリプトを修正することもできます。</p>
</div>
<div class="section" id="adding-contextual-information-to-your-logging-output">
<span id="context-info"></span><h2>コンテキスト情報をログ記録出力に付加する<a class="headerlink" href="#adding-contextual-information-to-your-logging-output" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>時にはログ記録出力にログ関数の呼び出し時に渡されたパラメータに加えてコンテキスト情報を含めたいこともあるでしょう。たとえば、ネットワークアプリケーションで、クライアント固有の情報 (例: リモートクライアントの名前、 IP アドレス) もログ記録に残しておきたいと思ったとしましょう。 <em>extra</em> パラメータをこの目的に使うこともできますが、いつでもこの方法で情報を渡すのが便利なやり方とも限りません。また接続ごとに <code class="xref py py-class docutils literal"><span class="pre">Logger</span></code> インスタンスを生成する誘惑に駆られるかもしれませんが、生成した <code class="xref py py-class docutils literal"><span class="pre">Logger</span></code> インスタンスはガーベジコレクションで回収されないので、これは良いアイデアとは言えません。この例は現実的な問題ではないかもしれませんが、 <code class="xref py py-class docutils literal"><span class="pre">Logger</span></code> インスタンスの個数がアプリケーションの中でログ記録が行われるレベルの粒度に依存する場合、 <code class="xref py py-class docutils literal"><span class="pre">Logger</span></code> インスタンスの個数が事実上無制限にならないと、管理が難しくなります。</p>
<div class="section" id="using-loggeradapters-to-impart-contextual-information">
<h3>LoggerAdapter を使ったコンテキスト情報の伝達<a class="headerlink" href="#using-loggeradapters-to-impart-contextual-information" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>logging イベントの情報と一緒に出力されるコンテキスト情報を渡す簡単な方法は、 <code class="xref py py-class docutils literal"><span class="pre">LoggerAdapter</span></code> を使うことです。このクラスは <code class="xref py py-class docutils literal"><span class="pre">Logger</span></code> のように見えるように設計されていて、 <code class="xref py py-meth docutils literal"><span class="pre">debug()</span></code>, <code class="xref py py-meth docutils literal"><span class="pre">info()</span></code>, <code class="xref py py-meth docutils literal"><span class="pre">warning()</span></code>, <code class="xref py py-meth docutils literal"><span class="pre">error()</span></code>, <code class="xref py py-meth docutils literal"><span class="pre">exception()</span></code>, <code class="xref py py-meth docutils literal"><span class="pre">critical()</span></code>, <code class="xref py py-meth docutils literal"><span class="pre">log()</span></code> の各メソッドを呼び出せるようになっています。これらのメソッドは対応する <code class="xref py py-class docutils literal"><span class="pre">Logger</span></code> のメソッドと同じ引数を取るので、二つの型を取り替えて使うことができます。</p>
<p><code class="xref py py-class docutils literal"><span class="pre">LoggerAdapter</span></code> のインスタンスを生成する際には、 <code class="xref py py-class docutils literal"><span class="pre">Logger</span></code> インスタンスとコンテキスト情報を収めた辞書風 (dict-like) のオブジェクトを渡します。 <code class="xref py py-class docutils literal"><span class="pre">LoggerAdapter</span></code> のログ記録メソッドを呼び出すと、呼び出しをコンストラクタに渡された配下の <code class="xref py py-class docutils literal"><span class="pre">Logger</span></code> インスタンスに委譲し、その際コンテキスト情報をその委譲された呼び出しに埋め込みます。 <code class="xref py py-class docutils literal"><span class="pre">LoggerAdapter</span></code> のコードから少し抜き出してみます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delegate a debug call to the underlying logger, after adding</span>
<span class="sd">    contextual information from this adapter instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="xref py py-class docutils literal"><span class="pre">LoggerAdapter</span></code> の <code class="xref py py-meth docutils literal"><span class="pre">process()</span></code> メソッドがコンテキスト情報をログ出力に加える場所です。 そこではログ記録呼び出しのメッセージとキーワード引数が渡され、 加工された (可能性のある) それらの情報を配下のロガーへの呼び出しに渡し直します。 このメソッドのデフォルト実装ではメッセージは元のままですが、 キーワード引数にはコンストラクタに渡された辞書風オブジェクトを値として &#8220;extra&#8221; キーが挿入されます。 もちろん、呼び出し時に &#8220;extra&#8221; キーワードを使った場合には何事もなかったかのように上書きされます。</p>
<p>&#8220;extra&#8221; を用いる利点は辞書風オブジェクトの中の値が <code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code> インスタンスの __dict__ にマージされることで、 辞書風オブジェクトのキーを知っている <code class="xref py py-class docutils literal"><span class="pre">Formatter</span></code> を用意して文字列をカスタマイズするようにできることです。 それ以外のメソッドが必要なとき、たとえばコンテキスト情報をメッセージの前や後ろにつなげたい場合には、 <code class="xref py py-class docutils literal"><span class="pre">LoggerAdapter</span></code> から <code class="xref py py-meth docutils literal"><span class="pre">process()</span></code> を望むようにオーバライドしたサブクラスを作ることが必要なだけです。 次に挙げるのはこのクラスを使った例で、コンストラクタで使われる「辞書風」オブジェクトにどの振る舞いが必要なのかも示しています:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CustomAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">LoggerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This example adapter expects the passed in dict-like object to have a</span>
<span class="sd">    &#39;connid&#39; key, whose value in brackets is prepended to the log message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;[%s] %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="s">&#39;connid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">),</span> <span class="n">kwargs</span>
</pre></div>
</div>
<p>これを次のように使うことができます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">adapter</span> <span class="o">=</span> <span class="n">CustomAdapter</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;connid&#39;</span><span class="p">:</span> <span class="n">some_conn_id</span><span class="p">})</span>
</pre></div>
</div>
<p>これで、この adapter 経由でログした全てのイベントに対して、 <code class="docutils literal"><span class="pre">some_conn_id</span></code> の値がログメッセージの前に追加されます。</p>
<div class="section" id="using-objects-other-than-dicts-to-pass-contextual-information">
<h4>コンテキスト情報を渡すために dict 以外のオブジェクトを使う<a class="headerlink" href="#using-objects-other-than-dicts-to-pass-contextual-information" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><code class="xref py py-class docutils literal"><span class="pre">LoggerAdapter</span></code> に渡すのは本物の dict でなくても構いません。
<code class="docutils literal"><span class="pre">__getitem__</span></code> と <code class="docutils literal"><span class="pre">__iter__</span></code> を実装していて logging が辞書のように扱えるクラスのインスタンスを利用することができます。
これは (dict の値が固定されるのに対して) 値を動的に生成できるので便利です。</p>
</div>
</div>
<div class="section" id="using-filters-to-impart-contextual-information">
<span id="filters-contextual"></span><h3>Filter を使ったコンテキスト情報の伝達<a class="headerlink" href="#using-filters-to-impart-contextual-information" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ユーザ定義の <code class="xref py py-class docutils literal"><span class="pre">Filter</span></code> を使ってログ出力にコンテキスト情報を加えることもできます。 <code class="docutils literal"><span class="pre">Filter</span></code> インスタンスは、渡された <code class="docutils literal"><span class="pre">LogRecords</span></code> を修正することができます。これにより、適切なフォーマット文字列や必要なら <code class="xref py py-class docutils literal"><span class="pre">Formatter</span></code> を使って、出力となる属性を新しく追加することも出来ます。</p>
<p>例えば、web アプリケーションで、処理されるリクエスト (または、少なくともその重要な部分) は、スレッドローカル (<a class="reference internal" href="../library/threading.html#threading.local" title="threading.local"><code class="xref py py-class docutils literal"><span class="pre">threading.local</span></code></a>) な変数に保存して、 <code class="docutils literal"><span class="pre">Filter</span></code> からアクセスすることで、 <code class="docutils literal"><span class="pre">LogRecord</span></code> にリクエストの情報を追加できます。例えば、リモート IP アドレスやリモートユーザのユーザ名にアクセスしたいなら、上述の <code class="docutils literal"><span class="pre">LoggerAdapter</span></code> の例のように属性名 &#8216;ip&#8217; や &#8216;user&#8217; を使うといったようにです。その場合、同じフォーマット文字列を使って以下に示すように似たような出力を得られます。これはスクリプトの例です:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">choice</span>

<span class="k">class</span> <span class="nc">ContextFilter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Filter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a filter which injects contextual information into the log.</span>

<span class="sd">    Rather than use actual contextual information, we just use random</span>
<span class="sd">    data in this demo.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">USERS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;jim&#39;</span><span class="p">,</span> <span class="s">&#39;fred&#39;</span><span class="p">,</span> <span class="s">&#39;sheila&#39;</span><span class="p">]</span>
    <span class="n">IPS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;123.231.231.123&#39;</span><span class="p">,</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="s">&#39;192.168.0.1&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>

        <span class="n">record</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">ContextFilter</span><span class="o">.</span><span class="n">IPS</span><span class="p">)</span>
        <span class="n">record</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">ContextFilter</span><span class="o">.</span><span class="n">USERS</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">True</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
   <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                       <span class="nb">format</span><span class="o">=</span><span class="s">&#39;%(asctime)-15s %(name)-5s %(levelname)-8s IP: %(ip)-15s User: %(user)-8s %(message)s&#39;</span><span class="p">)</span>
   <span class="n">a1</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;a.b.c&#39;</span><span class="p">)</span>
   <span class="n">a2</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;d.e.f&#39;</span><span class="p">)</span>

   <span class="n">f</span> <span class="o">=</span> <span class="n">ContextFilter</span><span class="p">()</span>
   <span class="n">a1</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
   <span class="n">a2</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
   <span class="n">a1</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;A debug message&#39;</span><span class="p">)</span>
   <span class="n">a1</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;An info message with %s&#39;</span><span class="p">,</span> <span class="s">&#39;some parameters&#39;</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
       <span class="n">lvl</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
       <span class="n">lvlname</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="n">lvl</span><span class="p">)</span>
       <span class="n">a2</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lvl</span><span class="p">,</span> <span class="s">&#39;A message at %s level with %d %s&#39;</span><span class="p">,</span> <span class="n">lvlname</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;parameters&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>そして、実行時に、以下のようになります:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">292</span> <span class="n">a</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">c</span> <span class="n">DEBUG</span>    <span class="n">IP</span><span class="p">:</span> <span class="mf">123.231</span><span class="o">.</span><span class="mf">231.123</span> <span class="n">User</span><span class="p">:</span> <span class="n">fred</span>     <span class="n">A</span> <span class="n">debug</span> <span class="n">message</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">300</span> <span class="n">a</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">c</span> <span class="n">INFO</span>     <span class="n">IP</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">User</span><span class="p">:</span> <span class="n">sheila</span>   <span class="n">An</span> <span class="n">info</span> <span class="n">message</span> <span class="k">with</span> <span class="n">some</span> <span class="n">parameters</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">300</span> <span class="n">d</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">f</span> <span class="n">CRITICAL</span> <span class="n">IP</span><span class="p">:</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>       <span class="n">User</span><span class="p">:</span> <span class="n">sheila</span>   <span class="n">A</span> <span class="n">message</span> <span class="n">at</span> <span class="n">CRITICAL</span> <span class="n">level</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">parameters</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">300</span> <span class="n">d</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">f</span> <span class="n">ERROR</span>    <span class="n">IP</span><span class="p">:</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>       <span class="n">User</span><span class="p">:</span> <span class="n">jim</span>      <span class="n">A</span> <span class="n">message</span> <span class="n">at</span> <span class="n">ERROR</span> <span class="n">level</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">parameters</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">300</span> <span class="n">d</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">f</span> <span class="n">DEBUG</span>    <span class="n">IP</span><span class="p">:</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>       <span class="n">User</span><span class="p">:</span> <span class="n">sheila</span>   <span class="n">A</span> <span class="n">message</span> <span class="n">at</span> <span class="n">DEBUG</span> <span class="n">level</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">parameters</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">300</span> <span class="n">d</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">f</span> <span class="n">ERROR</span>    <span class="n">IP</span><span class="p">:</span> <span class="mf">123.231</span><span class="o">.</span><span class="mf">231.123</span> <span class="n">User</span><span class="p">:</span> <span class="n">fred</span>     <span class="n">A</span> <span class="n">message</span> <span class="n">at</span> <span class="n">ERROR</span> <span class="n">level</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">parameters</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">300</span> <span class="n">d</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">f</span> <span class="n">CRITICAL</span> <span class="n">IP</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">User</span><span class="p">:</span> <span class="n">jim</span>      <span class="n">A</span> <span class="n">message</span> <span class="n">at</span> <span class="n">CRITICAL</span> <span class="n">level</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">parameters</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">300</span> <span class="n">d</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">f</span> <span class="n">CRITICAL</span> <span class="n">IP</span><span class="p">:</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>       <span class="n">User</span><span class="p">:</span> <span class="n">sheila</span>   <span class="n">A</span> <span class="n">message</span> <span class="n">at</span> <span class="n">CRITICAL</span> <span class="n">level</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">parameters</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">300</span> <span class="n">d</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">f</span> <span class="n">DEBUG</span>    <span class="n">IP</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.1</span>     <span class="n">User</span><span class="p">:</span> <span class="n">jim</span>      <span class="n">A</span> <span class="n">message</span> <span class="n">at</span> <span class="n">DEBUG</span> <span class="n">level</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">parameters</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">301</span> <span class="n">d</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">f</span> <span class="n">ERROR</span>    <span class="n">IP</span><span class="p">:</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>       <span class="n">User</span><span class="p">:</span> <span class="n">sheila</span>   <span class="n">A</span> <span class="n">message</span> <span class="n">at</span> <span class="n">ERROR</span> <span class="n">level</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">parameters</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">301</span> <span class="n">d</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">f</span> <span class="n">DEBUG</span>    <span class="n">IP</span><span class="p">:</span> <span class="mf">123.231</span><span class="o">.</span><span class="mf">231.123</span> <span class="n">User</span><span class="p">:</span> <span class="n">fred</span>     <span class="n">A</span> <span class="n">message</span> <span class="n">at</span> <span class="n">DEBUG</span> <span class="n">level</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">parameters</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">22</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">301</span> <span class="n">d</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">f</span> <span class="n">INFO</span>     <span class="n">IP</span><span class="p">:</span> <span class="mf">123.231</span><span class="o">.</span><span class="mf">231.123</span> <span class="n">User</span><span class="p">:</span> <span class="n">fred</span>     <span class="n">A</span> <span class="n">message</span> <span class="n">at</span> <span class="n">INFO</span> <span class="n">level</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">parameters</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="logging-to-a-single-file-from-multiple-processes">
<span id="multiple-processes"></span><h2>複数のプロセスからの単一ファイルへのログ記録<a class="headerlink" href="#logging-to-a-single-file-from-multiple-processes" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ログ記録はスレッドセーフであり、単一プロセスの複数のスレッドからの 単一ファイルへのログ記録はサポート <em>されています</em> が、 <em>複数プロセス</em> からの単一ファイルへのログ記録はサポート <em>されません</em> 。
なぜなら、複数のプロセスをまたいで単一のファイルへのアクセスを直列化する 標準の方法が Python には存在しないからです。
複数のプロセスから単一ファイルへログ記録しなければならないなら、最も良い方法は、 すべてのプロセスが <code class="xref py py-class docutils literal"><span class="pre">SocketHandler</span></code> に対してログ記録を行い、 独立したプロセスとしてソケットサーバを動かすことです。 ソケットサーバはソケットから読み取ってファイルにログを書き出します。 (この機能を実行するために、既存のプロセスの 1 つのスレッドを割り当てることもできます) <a class="reference internal" href="#network-logging"><span>この節</span></a> では、このアプローチをさらに詳細に文書化しています。 動作するソケット受信プログラムが含まれているので、 アプリケーションに組み込むための出発点として使用できるでしょう。</p>
<p><a class="reference internal" href="../library/multiprocessing.html#module-multiprocessing" title="multiprocessing: Process-based parallelism."><code class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></code></a> モジュールを含む最近のバージョンの Python を使用しているなら、 複数のプロセスからファイルへのアクセスを直列化するために <a class="reference internal" href="../library/multiprocessing.html#multiprocessing.Lock" title="multiprocessing.Lock"><code class="xref py py-class docutils literal"><span class="pre">Lock</span></code></a> クラスを使って独自のハンドラを書くことができます。 既存の <code class="xref py py-class docutils literal"><span class="pre">FileHandler</span></code> とそのサブクラスは現在のところ <a class="reference internal" href="../library/multiprocessing.html#module-multiprocessing" title="multiprocessing: Process-based parallelism."><code class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></code></a> を利用していませんが、 将来は利用するようになるかもしれません。 現在のところ <a class="reference internal" href="../library/multiprocessing.html#module-multiprocessing" title="multiprocessing: Process-based parallelism."><code class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></code></a> モジュールが提供するロック機能は すべてのプラットホームで動作するわけではないことに注意してください。 (<a class="reference external" href="http://bugs.python.org/issue3770">http://bugs.python.org/issue3770</a> 参照)</p>
<p>別の方法として、 <code class="docutils literal"><span class="pre">Queue</span></code> と <a class="reference internal" href="../library/logging.handlers.html#logging.handlers.QueueHandler" title="logging.handlers.QueueHandler"><code class="xref py py-class docutils literal"><span class="pre">QueueHandler</span></code></a> を使って、マルチプロセスアプリケーションの1つのプロセスに全ての logging イベントを送る事ができます。
次の例はこれを行う方法を示します。この例では独立した listener プロセスが他のプロセスから送られた event を受け取り、それを独自の logging 設定にしたがって保存します。
この例は実装の方法の1つを示しているだけ (例えば、 listener プロセスを分離する代わりに listener スレッドを使うこともできます) ですが、これは listener とアプリケーション内の他のプロセスで完全に異なる設定を使う例になっているので、各自の要求に応じたコードを書く叩き台になるでしょう:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="c"># You&#39;ll need these imports in your own code</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="c"># Next two import lines for this demo only</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">choice</span><span class="p">,</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c">#</span>
<span class="c"># Because you&#39;ll want to define the logging configurations for listener and workers, the</span>
<span class="c"># listener and worker process functions take a configurer parameter which is a callable</span>
<span class="c"># for configuring logging for that process. These functions are also passed the queue,</span>
<span class="c"># which they use for communication.</span>
<span class="c">#</span>
<span class="c"># In practice, you can configure the listener however you want, but note that in this</span>
<span class="c"># simple example, the listener does not apply level or filter logic to received records.</span>
<span class="c"># In practice, you would probably want to do this logic in the worker processes, to avoid</span>
<span class="c"># sending events which would be filtered out between processes.</span>
<span class="c">#</span>
<span class="c"># The size of the rotated files is made small so you can see the results easily.</span>
<span class="k">def</span> <span class="nf">listener_configurer</span><span class="p">():</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">(</span><span class="s">&#39;mptest.log&#39;</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;%(asctime)s %(processName)-10s %(name)s %(levelname)-8s %(message)s&#39;</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

<span class="c"># This is the listener process top-level loop: wait for logging events</span>
<span class="c"># (LogRecords)on the queue and handle them, quit when you get a None for a</span>
<span class="c"># LogRecord.</span>
<span class="k">def</span> <span class="nf">listener_process</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">configurer</span><span class="p">):</span>
    <span class="n">configurer</span><span class="p">()</span>
    <span class="k">while</span> <span class="k">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span> <span class="c"># We send this as a sentinel to tell the listener to quit.</span>
                <span class="k">break</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="c"># No level or filter logic applied - just do it!</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">traceback</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Whoops! Problem:&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

<span class="c"># Arrays used for random selections in this demo</span>

<span class="n">LEVELS</span> <span class="o">=</span> <span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">]</span>

<span class="n">LOGGERS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;a.b.c&#39;</span><span class="p">,</span> <span class="s">&#39;d.e.f&#39;</span><span class="p">]</span>

<span class="n">MESSAGES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;Random message #1&#39;</span><span class="p">,</span>
    <span class="s">&#39;Random message #2&#39;</span><span class="p">,</span>
    <span class="s">&#39;Random message #3&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c"># The worker configuration is done at the start of the worker process run.</span>
<span class="c"># Note that on Windows you can&#39;t rely on fork semantics, so each process</span>
<span class="c"># will run the logging configuration code when it starts.</span>
<span class="k">def</span> <span class="nf">worker_configurer</span><span class="p">(</span><span class="n">queue</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">QueueHandler</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="c"># Just the one handler needed</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span> <span class="c"># send all messages, for demo; no other level or filter logic applied.</span>

<span class="c"># This is the worker process top-level loop, which just logs ten events with</span>
<span class="c"># random intervening delays before terminating.</span>
<span class="c"># The print messages are just so you know it&#39;s doing something!</span>
<span class="k">def</span> <span class="nf">worker_process</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">configurer</span><span class="p">):</span>
    <span class="n">configurer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Worker started: %s&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">())</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">choice</span><span class="p">(</span><span class="n">LOGGERS</span><span class="p">))</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">LEVELS</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">MESSAGES</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Worker finished: %s&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

<span class="c"># Here&#39;s where the demo gets orchestrated. Create the queue, create and start</span>
<span class="c"># the listener, create ten workers and start them, wait for them to finish,</span>
<span class="c"># then send a None to the queue to tell the listener to finish.</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">listener_process</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">listener_configurer</span><span class="p">))</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker_process</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">worker_configurer</span><span class="p">))</span>
        <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
        <span class="n">w</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="k">None</span><span class="p">)</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>上のスクリプトの亜種で、 logging をメインプロセスの別スレッドで行う例:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.config</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">logger_thread</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="k">while</span> <span class="k">True</span><span class="p">:</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">worker_process</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">qh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">QueueHandler</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">qh</span><span class="p">)</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
              <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">]</span>
    <span class="n">loggers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="s">&#39;foo.bar&#39;</span><span class="p">,</span> <span class="s">&#39;foo.bar.baz&#39;</span><span class="p">,</span>
               <span class="s">&#39;spam&#39;</span><span class="p">,</span> <span class="s">&#39;spam.ham&#39;</span><span class="p">,</span> <span class="s">&#39;spam.ham.eggs&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">lvl</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">loggers</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lvl</span><span class="p">,</span> <span class="s">&#39;Message no. %d&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">&#39;formatters&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;detailed&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.Formatter&#39;</span><span class="p">,</span>
                <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;%(asctime)s %(name)-15s %(levelname)-8s %(processName)-10s %(message)s&#39;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;console&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.StreamHandler&#39;</span><span class="p">,</span>
                <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;INFO&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s">&#39;file&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.FileHandler&#39;</span><span class="p">,</span>
                <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="s">&#39;mplog.log&#39;</span><span class="p">,</span>
                <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
                <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;detailed&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s">&#39;foofile&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.FileHandler&#39;</span><span class="p">,</span>
                <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="s">&#39;mplog-foo.log&#39;</span><span class="p">,</span>
                <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
                <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;detailed&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s">&#39;errors&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.FileHandler&#39;</span><span class="p">,</span>
                <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="s">&#39;mplog-errors.log&#39;</span><span class="p">,</span>
                <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
                <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;ERROR&#39;</span><span class="p">,</span>
                <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;detailed&#39;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s">&#39;loggers&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;foofile&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
            <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;console&#39;</span><span class="p">,</span> <span class="s">&#39;file&#39;</span><span class="p">,</span> <span class="s">&#39;errors&#39;</span><span class="p">]</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker_process</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;worker %d&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
        <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">logger_thread</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
    <span class="n">lp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c"># At this point, the main process could do some useful work of its own</span>
    <span class="c"># Once it&#39;s done that, it can wait for the workers to terminate...</span>
    <span class="k">for</span> <span class="n">wp</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="c"># And now tell the logging thread to finish up, too</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="k">None</span><span class="p">)</span>
    <span class="n">lp</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>こちらは特定の logger に設定を適用する例になっています。
<code class="docutils literal"><span class="pre">foo</span></code> logger は <code class="docutils literal"><span class="pre">foo</span></code> サブシステムの中の全てのイベントを <code class="docutils literal"><span class="pre">mplog-foo.log</span></code> に保存する特別な handler を持っています。
これはメインプロセス側の log 処理で使われ、 (logging イベントは worker プロセス側で生成されますが) 各メッセージを適切な出力先に出力します。</p>
</div>
<div class="section" id="using-file-rotation">
<h2>ファイルをローテートする<a class="headerlink" href="#using-file-rotation" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ログファイルがある大きさに達したら、新しいファイルを開いてそこにログを取りたいことがあります。そのファイルをある数だけ残し、その数のファイルが生成されたらファイルを循環し、ファイルの数も大きさも制限したいことも あるでしょう。この利用パターンのために、logging パッケージは <code class="xref py py-class docutils literal"><span class="pre">RotatingFileHandler</span></code> を提供しています:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>

<span class="n">LOG_FILENAME</span> <span class="o">=</span> <span class="s">&#39;logging_rotatingfile_example.out&#39;</span>

<span class="c"># Set up a specific logger with our desired output level</span>
<span class="n">my_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;MyLogger&#39;</span><span class="p">)</span>
<span class="n">my_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="c"># Add the log message handler to the logger</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">(</span>
              <span class="n">LOG_FILENAME</span><span class="p">,</span> <span class="n">maxBytes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">backupCount</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">my_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

<span class="c"># Log some messages</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;i = %d&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

<span class="c"># See what files are created</span>
<span class="n">logfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&#39;%s*&#39;</span> <span class="o">%</span> <span class="n">LOG_FILENAME</span><span class="p">)</span>

<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">logfiles</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>この結果として、アプリケーションのログ履歴の一部である、 6 つに別れたファイルが得られます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">logging_rotatingfile_example</span><span class="o">.</span><span class="n">out</span>
<span class="n">logging_rotatingfile_example</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="mi">1</span>
<span class="n">logging_rotatingfile_example</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="mi">2</span>
<span class="n">logging_rotatingfile_example</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="mi">3</span>
<span class="n">logging_rotatingfile_example</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="mi">4</span>
<span class="n">logging_rotatingfile_example</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="mi">5</span>
</pre></div>
</div>
<p>最新のファイルはいつでも <code class="file docutils literal"><span class="pre">logging_rotatingfile_example.out</span></code> で、サイズの上限に達するたびに拡張子 <code class="docutils literal"><span class="pre">.1</span></code> を付けた名前に改名されます。既にあるバックアップファイルはその拡張子がインクリメントされ (<code class="docutils literal"><span class="pre">.1</span></code> が <code class="docutils literal"><span class="pre">.2</span></code> になるなど)、 <code class="docutils literal"><span class="pre">.6</span></code> ファイルは消去されます。</p>
<p>明らかに、ここでは極端な例示のためにファイルの大きさをかなり小さな値に設定しています。実際に使うときは <em>maxBytes</em> を適切な値に設定してください。</p>
</div>
<div class="section" id="use-of-alternative-formatting-styles">
<span id="format-styles"></span><h2>別の format スタイルを利用する<a class="headerlink" href="#use-of-alternative-formatting-styles" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>logging が Python 標準ライブラリに追加された時、メッセージを動的な内容でフォーマットする唯一の方法は % を使ったフォーマットでした。
その後、 Python には新しい文字列フォーマット機構として <a class="reference internal" href="../library/string.html#string.Template" title="string.Template"><code class="xref py py-class docutils literal"><span class="pre">string.Template</span></code></a> (Python 2.4 で追加) と <a class="reference internal" href="../library/stdtypes.html#str.format" title="str.format"><code class="xref py py-meth docutils literal"><span class="pre">str.format()</span></code></a> (Python 2.6 で追加) が加わりました。</p>
<p>logging は (3.2 から) この2つの追加されたフォーマット方法をサポートしています。
<code class="xref py py-class docutils literal"><span class="pre">Formatter</span></code> クラスが <code class="docutils literal"><span class="pre">style</span></code> という名前のオプションのキーワード引数を受け取ります。このデフォルト値は <code class="docutils literal"><span class="pre">'%'</span></code> ですが、他に <code class="docutils literal"><span class="pre">'{'</span></code> と <code class="docutils literal"><span class="pre">'$'</span></code> が指定可能で、それぞれのフォーマット方法に対応しています。
後方互換性はデフォルト値によって維持されていますが、明示的に style 引数を指定することで、 <a class="reference internal" href="../library/stdtypes.html#str.format" title="str.format"><code class="xref py py-meth docutils literal"><span class="pre">str.format()</span></code></a> か <a class="reference internal" href="../library/string.html#string.Template" title="string.Template"><code class="xref py py-class docutils literal"><span class="pre">string.Template</span></code></a> を使った format を指定する事ができます。
次の例はこの機能を使ってみています:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">logging</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">root</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">root</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bf</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;{asctime} {name} {levelname:8s} {message}&#39;</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">style</span><span class="o">=</span><span class="s">&#39;{&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">bf</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">root</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;foo.bar&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;This is a DEBUG message&#39;</span><span class="p">)</span>
<span class="go">2010-10-28 15:11:55,341 foo.bar DEBUG    This is a DEBUG message</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;This is a CRITICAL message&#39;</span><span class="p">)</span>
<span class="go">2010-10-28 15:12:11,526 foo.bar CRITICAL This is a CRITICAL message</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;$asctime $name ${levelname} $message&#39;</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">style</span><span class="o">=</span><span class="s">&#39;$&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;This is a DEBUG message&#39;</span><span class="p">)</span>
<span class="go">2010-10-28 15:13:06,924 foo.bar DEBUG This is a DEBUG message</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;This is a CRITICAL message&#39;</span><span class="p">)</span>
<span class="go">2010-10-28 15:13:11,494 foo.bar CRITICAL This is a CRITICAL message</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>最終的に出力されるログメッセージの format と、各メッセージを生成する部分は完全に独立していることに注意してください。
次の例でわかるように、メッセージを生成する部分では % を使い続けています:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;This is an%s %s %s&#39;</span><span class="p">,</span> <span class="s">&#39;other,&#39;</span><span class="p">,</span> <span class="s">&#39;ERROR,&#39;</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">)</span>
<span class="go">2010-10-28 15:19:29,833 foo.bar ERROR This is another, ERROR, message</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>logging の呼び出し (<code class="docutils literal"><span class="pre">logger.debug()</span></code> や <code class="docutils literal"><span class="pre">logger.info()</span></code> など) は、ログメッセージのために位置引数しか受け取らず、キーワード引数はそれを処理するときのオプションを指定するためだけに使われます。 (例えば、 <code class="docutils literal"><span class="pre">exc_info</span></code> キーワード引数を使ってログを取るトレースバック情報を指定したり、 <code class="docutils literal"><span class="pre">extra</span></code> キーワード引数を使ってログに付与する追加のコンテキスト情報を指定します。)
logging パッケージは内部で % を使って format 文字列と引数をマージしているので、 <a class="reference internal" href="../library/stdtypes.html#str.format" title="str.format"><code class="xref py py-meth docutils literal"><span class="pre">str.format()</span></code></a> や <a class="reference internal" href="../library/string.html#string.Template" title="string.Template"><code class="xref py py-class docutils literal"><span class="pre">string.Template</span></code></a> を使って logging を呼び出す事はできません。
既存の logging 呼び出しは %-format を使っているので、後方互換性のためにこの部分を変更することはできません。</p>
<p>しかし、 {} や $ を使ってログメッセージをフォーマットする方法はあります。
ログメッセージには任意のオブジェクトを format 文字列として渡すことができ、 logging パッケージはそのオブジェクトに対して <code class="docutils literal"><span class="pre">str()</span></code> を使って実際の format 文字列を生成します。次の2つのクラスを見てください:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="k">class</span> <span class="nc">BraceMessage</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DollarMessage</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">string</span> <span class="k">import</span> <span class="n">Template</span>
        <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>どちらのクラスも format 文字列の代わりに利用して、 {} や $ を使って実際のログの &#8220;%(message)s&#8221;, &#8220;{message}&#8221;, &#8220;$message&#8221; で指定された &#8220;message&#8221; 部分を生成することができます。
これは何かログを取りたいときに常に使うには使いにくいクラス名ですが、 __ (アンダースコア2つ &#8211; <a class="reference internal" href="../library/gettext.html#gettext.gettext" title="gettext.gettext"><code class="xref py py-func docutils literal"><span class="pre">gettext.gettext()</span></code></a> やその仲間によくエイリアスとして使われるアンダースコア1つと混同しないように) などの使いやすいエイリアスを使うことができます。</p>
<p>上のクラスは Python には含まれませんが、自分のコードにコピペして使うのは簡単です。
これらは次の例のようにして利用できます。 (上のクラスが <code class="docutils literal"><span class="pre">wherever</span></code> というモジュールで定義されていると仮定します):</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">wherever</span> <span class="kn">import</span> <span class="n">BraceMessage</span> <span class="k">as</span> <span class="n">__</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">__</span><span class="p">(</span><span class="s">&#39;Message with {0} {name}&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;placeholders&#39;</span><span class="p">))</span>
<span class="go">Message with 2 placeholders</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">:</span> <span class="k">pass</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">__</span><span class="p">(</span><span class="s">&#39;Message with coordinates: ({point.x:.2f}, {point.y:.2f})&#39;</span><span class="p">,</span>
<span class="gp">... </span>      <span class="n">point</span><span class="o">=</span><span class="n">p</span><span class="p">))</span>
<span class="go">Message with coordinates: (0.50, 0.50)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">wherever</span> <span class="kn">import</span> <span class="n">DollarMessage</span> <span class="k">as</span> <span class="n">__</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">__</span><span class="p">(</span><span class="s">&#39;Message with $num $what&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s">&#39;placeholders&#39;</span><span class="p">))</span>
<span class="go">Message with 2 placeholders</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>上の例ではフォーマットの動作を示すために <code class="docutils literal"><span class="pre">print()</span></code> を使っていますが、もちろん実際にこの方法でログを出力するには <code class="docutils literal"><span class="pre">logger.debug()</span></code> などを使います。</p>
<p>注意点として、この方法には大きなパフォーマンスのペナルティはありません。
実際のフォーマット操作は logging の呼び出し時ではなくて、メッセージが実際に handler によって出力されるときに起こります。 (出力されないならフォーマットもされません)
そのため、この方法で注意しないといけないのは、追加の括弧がフォーマット文字列だけではなく引数も囲わないといけないことだけです。これは __ が XXXMessage クラスのコンストラクタ呼び出しのシンタックスシュガーでしか無いからです。</p>
<p>次の例のように、 <code class="xref py py-class docutils literal"><span class="pre">LoggerAdapter</span></code> を利用して上と似たような効果を実現する方法もあります:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>

<span class="k">class</span> <span class="nc">Message</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StyleAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">LoggerAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StyleAdapter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">extra</span> <span class="ow">or</span> <span class="p">{})</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">level</span><span class="p">):</span>
            <span class="n">msg</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">Message</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">StyleAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Hello, {}&#39;</span><span class="p">,</span> <span class="s">&#39;world!&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>上のスクリプトは Python 3.2 以降では <code class="docutils literal"><span class="pre">Hello,</span> <span class="pre">world!</span></code> というメッセージをログするはずです。</p>
</div>
<div class="section" id="customizing-logrecord">
<span id="custom-logrecord"></span><h2><code class="docutils literal"><span class="pre">LogRecord</span></code> のカスタマイズ<a class="headerlink" href="#customizing-logrecord" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>全ての logging イベントは <a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a> のインスタンスとして表現されます。
イベントのログが取られて logger のレベルでフィルタされなかった場合、イベントの情報を含む <a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a> が生成され、
その logger (と、 propagate が無効になるまでの上位 logger) の handler に渡されます。
Python 3.2 までは、この生成が行われているのは2箇所だけでした:</p>
<ul class="simple">
<li><p class="first"><a class="reference internal" href="../library/logging.html#logging.Logger.makeRecord" title="logging.Logger.makeRecord"><code class="xref py py-meth docutils literal"><span class="pre">Logger.makeRecord()</span></code></a>: 通常のイベント logging プロセスで呼ばれます。これは <a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a> を直接読んでインスタンスを生成します。</p>
</li>
<li><p class="first"><a class="reference internal" href="../library/logging.html#logging.makeLogRecord" title="logging.makeLogRecord"><code class="xref py py-func docutils literal"><span class="pre">makeLogRecord()</span></code></a>: LogRecord に追加される属性を含む辞書を渡して呼び出されます。これはネットワーク越しに (pickle 形式で <a class="reference internal" href="../library/logging.handlers.html#logging.handlers.SocketHandler" title="logging.handlers.SocketHandler"><code class="xref py py-class docutils literal"><span class="pre">SocketHandler</span></code></a> 経由で、あるいは JSON 形式で <a class="reference internal" href="../library/logging.handlers.html#logging.handlers.HTTPHandler" title="logging.handlers.HTTPHandler"><code class="xref py py-class docutils literal"><span class="pre">HTTPHandler</span></code></a> 経由で) 辞書を受け取った場合などに利用されます。</p>
</li>
</ul>
<p>そのために <a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a> で何か特別なことをしたい場合は、次のどちらかをしなければなりません。</p>
<ul class="simple">
<li><p class="first"><a class="reference internal" href="../library/logging.html#logging.Logger.makeRecord" title="logging.Logger.makeRecord"><code class="xref py py-meth docutils literal"><span class="pre">Logger.makeRecord()</span></code></a> をオーバーライドした独自の <a class="reference internal" href="../library/logging.html#logging.Logger" title="logging.Logger"><code class="xref py py-class docutils literal"><span class="pre">Logger</span></code></a> のサブクラスを作り、
利用したい logger のどれかがインスタンス化される前に、それを <a class="reference internal" href="../library/logging.html#logging.setLoggerClass" title="logging.setLoggerClass"><code class="xref py py-func docutils literal"><span class="pre">setLoggerClass()</span></code></a> を使って登録する。</p>
</li>
<li><p class="first"><a class="reference internal" href="../library/logging.html#logging.Filter.filter" title="logging.Filter.filter"><code class="xref py py-meth docutils literal"><span class="pre">filter()</span></code></a> メソッドで必要な特殊な処理を行う <a class="reference internal" href="../library/logging.html#logging.Filter" title="logging.Filter"><code class="xref py py-class docutils literal"><span class="pre">Filter</span></code></a> を logger か handler に追加する。</p>
</li>
</ul>
<p>最初の方法は、複数の異なるライブラリが別々のことをしようとした場合にうまく行きません。
各ライブラリが独自の <a class="reference internal" href="../library/logging.html#logging.Logger" title="logging.Logger"><code class="xref py py-class docutils literal"><span class="pre">Logger</span></code></a> のサブクラスを登録しようとして、最後に登録されたライブラリが生き残ります。</p>
<p>2つ目の方法はほとんどのケースでうまくいきますが、たとえば <a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a> を特殊化したサブクラスを使うことなどはできません。
ライブラリの開発者は利用している logger に適切な filter を設定できますが、新しい logger を作るたびに忘れずに設定しないといけなくなります。
(新しいパッケージやモジュールを追加し、モジュールレベルで次の式を実行することで、新しい logger が作られます):</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</pre></div>
</div>
<p>これでは考えることが余計に1つ増えてしまうでしょう。
開発者は、最も高いレベルのロガーに取り付けられた <a class="reference internal" href="../library/logging.handlers.html#logging.NullHandler" title="logging.NullHandler"><code class="xref py py-class docutils literal"><span class="pre">NullHandler</span></code></a> に、フィルタを追加することもできますが、
アプリケーション開発者が、より低いレベルに対するライブラリのロガーにハンドラを取り付けた場合、フィルタは呼び出されません - 従って、そのハンドラからの出力はライブラリ開発者の意図を反映したものにはなりません。</p>
<p>Python 3.2 以降では、 <a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a> の生成は、指定できるファクトリ経由になります。
ファクトリは callable で、 <a class="reference internal" href="../library/logging.html#logging.setLogRecordFactory" title="logging.setLogRecordFactory"><code class="xref py py-func docutils literal"><span class="pre">setLogRecordFactory()</span></code></a> で登録でき、 <a class="reference internal" href="../library/logging.html#logging.getLogRecordFactory" title="logging.getLogRecordFactory"><code class="xref py py-func docutils literal"><span class="pre">getLogRecordFactory()</span></code></a> で現在のファクトリを取得できます。
ファクトリは <a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a> コンストラクタと同じシグネチャで呼び出され、 <a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a> がデフォルトのファクトリとして設定されています。</p>
<p>このアプローチはカスタムのファクトリが LogRecord の生成のすべての面を制御できるようにしています。
たとえば、サブクラスを返したり、次のようなパターンを使って単に属性を追加することができます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">old_factory</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogRecordFactory</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">record_factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">old_factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">record</span><span class="o">.</span><span class="n">custom_attribute</span> <span class="o">=</span> <span class="mh">0xdecafbad</span>
    <span class="k">return</span> <span class="n">record</span>

<span class="n">logging</span><span class="o">.</span><span class="n">setLogRecordFactory</span><span class="p">(</span><span class="n">record_factory</span><span class="p">)</span>
</pre></div>
</div>
<p>このアプローチでは複数の異なるライブラリがファクトリをチェインさせて、お互いに同じ属性を上書きしたり、標準で提供されている属性を意図せず上書きしない限りはうまくいきます。
しかし、チェインのつながり全てが、全ての logging の操作に対しての実行時のオーバーヘッドになることを念頭に置き、
このテクニックは <a class="reference internal" href="../library/logging.html#logging.Filter" title="logging.Filter"><code class="xref py py-class docutils literal"><span class="pre">Filter</span></code></a> を利用するだけでは望む結果が得られない場合にのみ使うべきです。</p>
</div>
<div class="section" id="subclassing-queuehandler-a-zeromq-example">
<span id="zeromq-handlers"></span><h2>QueueHandler を継承する - ZeroMQ を使う例<a class="headerlink" href="#subclassing-queuehandler-a-zeromq-example" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="xref py py-class docutils literal"><span class="pre">QueueHandler</span></code> のサブクラスを作ってメッセージを他のキュー、例えば ZeroMQ の &#8216;publish&#8217; ソケットに送信することができます。下の例では、ソケットを別に作ってそれを handler に (&#8216;queue&#8217; として) 渡します。</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">zmq</span> <span class="c"># using pyzmq, the Python binding for ZeroMQ</span>
<span class="kn">import</span> <span class="nn">json</span> <span class="c"># for serializing records portably</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">sock</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span> <span class="c"># or zmq.PUSH, or other suitable value</span>
<span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">&#39;tcp://*:5556&#39;</span><span class="p">)</span> <span class="c"># or wherever</span>

<span class="k">class</span> <span class="nc">ZeroMQSocketHandler</span><span class="p">(</span><span class="n">QueueHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">handler</span> <span class="o">=</span> <span class="n">ZeroMQSocketHandler</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
</pre></div>
</div>
<p>もちろん同じことを別の設計でもできます。 socket を作るのに必要な情報を handler に渡す例です:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ZeroMQSocketHandler</span><span class="p">(</span><span class="n">QueueHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">socktype</span><span class="o">=</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span> <span class="ow">or</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">socktype</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="n">QueueHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="subclassing-queuelistener-a-zeromq-example">
<h2>QueueListener のサブクラスを作る - ZeroMQ を使う例<a class="headerlink" href="#subclassing-queuelistener-a-zeromq-example" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="xref py py-class docutils literal"><span class="pre">QueueListener</span></code> のサブクラスを作って、メッセージを他のキュー、例えば ZeroMQ の &#8216;subscribe&#8217; ソケットから取得する事もできます。サンプルです:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ZeroMQSocketListener</span><span class="p">(</span><span class="n">QueueListener</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="o">*</span><span class="n">handlers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ctx&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="c"># subscribe to everything</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dequeue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">makeLogRecord</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">参考</p>
<dl class="docutils">
<dt><a class="reference internal" href="../library/logging.html#module-logging" title="logging: Flexible event logging system for applications."><code class="xref py py-mod docutils literal"><span class="pre">logging</span></code></a> モジュール</dt>
<dd><p class="first last">logging モジュールの API リファレンス。</p>
</dd>
<dt><a class="reference internal" href="../library/logging.config.html#module-logging.config" title="logging.config: Configuration of the logging module."><code class="xref py py-mod docutils literal"><span class="pre">logging.config</span></code></a> モジュール</dt>
<dd><p class="first last">logging モジュールの環境設定 API です。</p>
</dd>
<dt><a class="reference internal" href="../library/logging.handlers.html#module-logging.handlers" title="logging.handlers: Handlers for the logging module."><code class="xref py py-mod docutils literal"><span class="pre">logging.handlers</span></code></a> モジュール</dt>
<dd><p class="first last">logging モジュールに含まれる、便利なハンドラです。</p>
</dd>
</dl>
<p><a class="reference internal" href="logging.html#logging-basic-tutorial"><span>logging 基本チュートリアル</span></a></p>
<p class="last"><a class="reference internal" href="logging.html#logging-advanced-tutorial"><span>logging 上級チュートリアル</span></a></p>
</div>
</div>
<div class="section" id="an-example-dictionary-based-configuration">
<h2>辞書ベースで構成する例<a class="headerlink" href="#an-example-dictionary-based-configuration" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>次の例は辞書を使った logging の構成です。
この例は <a class="reference external" href="https://docs.djangoproject.com/en/1.3/topics/logging/#configuring-logging">Django プロジェクトのドキュメント</a> から持ってきました。
この辞書を <a class="reference internal" href="../library/logging.config.html#logging.config.dictConfig" title="logging.config.dictConfig"><code class="xref py py-func docutils literal"><span class="pre">dictConfig()</span></code></a> に渡して設定を有効にします。</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">LOGGING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;disable_existing_loggers&#39;</span><span class="p">:</span> <span class="k">True</span><span class="p">,</span>
    <span class="s">&#39;formatters&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;verbose&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;%(levelname)s %(asctime)s %(module)s %(process)d %(thread)d %(message)s&#39;</span>
        <span class="p">},</span>
        <span class="s">&#39;simple&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;%(levelname)s %(message)s&#39;</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s">&#39;filters&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;special&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;()&#39;</span><span class="p">:</span> <span class="s">&#39;project.logging.SpecialFilter&#39;</span><span class="p">,</span>
            <span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="s">&#39;bar&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;null&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span><span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
            <span class="s">&#39;class&#39;</span><span class="p">:</span><span class="s">&#39;django.utils.log.NullHandler&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;console&#39;</span><span class="p">:{</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span><span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
            <span class="s">&#39;class&#39;</span><span class="p">:</span><span class="s">&#39;logging.StreamHandler&#39;</span><span class="p">,</span>
            <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;simple&#39;</span>
        <span class="p">},</span>
        <span class="s">&#39;mail_admins&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;ERROR&#39;</span><span class="p">,</span>
            <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;django.utils.log.AdminEmailHandler&#39;</span><span class="p">,</span>
            <span class="s">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;special&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s">&#39;loggers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;django&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;handlers&#39;</span><span class="p">:[</span><span class="s">&#39;null&#39;</span><span class="p">],</span>
            <span class="s">&#39;propagate&#39;</span><span class="p">:</span> <span class="k">True</span><span class="p">,</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span><span class="s">&#39;INFO&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;django.request&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;mail_admins&#39;</span><span class="p">],</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;ERROR&#39;</span><span class="p">,</span>
            <span class="s">&#39;propagate&#39;</span><span class="p">:</span> <span class="k">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;myproject.custom&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;console&#39;</span><span class="p">,</span> <span class="s">&#39;mail_admins&#39;</span><span class="p">],</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;INFO&#39;</span><span class="p">,</span>
            <span class="s">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;special&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>この構成方法についてのより詳しい情報は、 Django のドキュメントの <a class="reference external" href="https://docs.djangoproject.com/en/1.3/topics/logging/#configuring-logging">該当のセクション</a> で見ることができます。</p>
</div>
<div class="section" id="using-a-rotator-and-namer-to-customize-log-rotation-processing">
<span id="cookbook-rotator-namer"></span><h2>rotator と namer を使ってログローテートをカスタマイズする<a class="headerlink" href="#using-a-rotator-and-namer-to-customize-log-rotation-processing" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>次の、ログファイルを zlib ベースの圧縮をするスニペットでは、 namer と rotater を定義する方法の例を提供してます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="k">def</span> <span class="nf">namer</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.gz&quot;</span>

<span class="k">def</span> <span class="nf">rotator</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sf</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">compressed</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">df</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

<span class="n">rh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">rh</span><span class="o">.</span><span class="n">rotator</span> <span class="o">=</span> <span class="n">rotator</span>
<span class="n">rh</span><span class="o">.</span><span class="n">namer</span> <span class="o">=</span> <span class="n">namer</span>
</pre></div>
</div>
<p>これは本当の .gz ファイルではなく、実際の gzip ファイルが持っている &#8220;コンテナ&#8221; がない生の圧縮データです。
このスニペットはただの解説用です。</p>
</div>
<div class="section" id="a-more-elaborate-multiprocessing-example">
<h2>より手の込んだ multiprocessing の例<a class="headerlink" href="#a-more-elaborate-multiprocessing-example" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>次の実際に動作する例は、 logging を multiprocessing と設定ファイルを使って利用する方法を示しています。
設定内容はかなりシンプルですが、より複雑な構成を実際の multiprocessing を利用するシナリオで実装する方法を示しています。</p>
<p>この例では、メインプロセスは listener プロセスといくつかのワーカープロセスを起動します。
メイン、 listener、ワーカープロセスはそれぞれ分離した設定を持っています (ワーカープロセス群は同じ設定を共有します)。
この例から、メインプロセスの logging, ワーカーが QueueHandler でログを送っているところ、 listener が利用する QueueListener の実装、複雑な設定、キューから受け取ったイベントを設定された handler に分配する部分を見ることができます。
この設定は説明用のものですが、この例を自分のシナリオに適応させることができるでしょう。</p>
<p>これがそのスクリプトです。 docstring とコメントで動作を説明しています:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.config</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">current_process</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">MyHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple handler for logging events. It runs in the listener process and</span>
<span class="sd">    dispatches events to loggers based on the name in the received record,</span>
<span class="sd">    which then get dispatched, by the logging system, to the handlers</span>
<span class="sd">    configured for those loggers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c"># The process name is transformed just to show that it&#39;s the listener</span>
        <span class="c"># doing the logging to files and console</span>
        <span class="n">record</span><span class="o">.</span><span class="n">processName</span> <span class="o">=</span> <span class="s">&#39;%s (for %s)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">processName</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">listener_process</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This could be done in the main process, but is just done in a separate</span>
<span class="sd">    process for illustrative purposes.</span>

<span class="sd">    This initialises logging according to the specified configuration,</span>
<span class="sd">    starts the listener and waits for the main process to signal completion</span>
<span class="sd">    via the event. The listener is then stopped, and the process exits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">QueueListener</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">MyHandler</span><span class="p">())</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;posix&#39;</span><span class="p">:</span>
        <span class="c"># On POSIX, the setup logger will have been configured in the</span>
        <span class="c"># parent process, but should have been disabled following the</span>
        <span class="c"># dictConfig call.</span>
        <span class="c"># On Windows, since fork isn&#39;t used, the setup logger won&#39;t</span>
        <span class="c"># exist in the child, so it would be created and the message</span>
        <span class="c"># would appear - hence the &quot;if posix&quot; clause.</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;setup&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Should not appear, because of disabled logger ...&#39;</span><span class="p">)</span>
    <span class="n">stop_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">worker_process</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A number of these are spawned for the purpose of illustration. In</span>
<span class="sd">    practice, they could be a heterogenous bunch of processes rather than</span>
<span class="sd">    ones which are identical to each other.</span>

<span class="sd">    This initialises logging according to the specified configuration,</span>
<span class="sd">    and logs a hundred messages with random levels to randomly selected</span>
<span class="sd">    loggers.</span>

<span class="sd">    A small sleep is added to allow other processes a chance to run. This</span>
<span class="sd">    is not strictly needed, but it mixes the output from the different</span>
<span class="sd">    processes a bit more than if it&#39;s left out.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
              <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">]</span>
    <span class="n">loggers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="s">&#39;foo.bar&#39;</span><span class="p">,</span> <span class="s">&#39;foo.bar.baz&#39;</span><span class="p">,</span>
               <span class="s">&#39;spam&#39;</span><span class="p">,</span> <span class="s">&#39;spam.ham&#39;</span><span class="p">,</span> <span class="s">&#39;spam.ham.eggs&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;posix&#39;</span><span class="p">:</span>
        <span class="c"># On POSIX, the setup logger will have been configured in the</span>
        <span class="c"># parent process, but should have been disabled following the</span>
        <span class="c"># dictConfig call.</span>
        <span class="c"># On Windows, since fork isn&#39;t used, the setup logger won&#39;t</span>
        <span class="c"># exist in the child, so it would be created and the message</span>
        <span class="c"># would appear - hence the &quot;if posix&quot; clause.</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;setup&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Should not appear, because of disabled logger ...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">lvl</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">loggers</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lvl</span><span class="p">,</span> <span class="s">&#39;Message no. %d&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="c"># The main process gets a simple configuration which prints to the console.</span>
    <span class="n">config_initial</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">&#39;formatters&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;detailed&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.Formatter&#39;</span><span class="p">,</span>
                <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;%(asctime)s %(name)-15s %(levelname)-8s %(processName)-10s %(message)s&#39;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;console&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.StreamHandler&#39;</span><span class="p">,</span>
                <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;INFO&#39;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
            <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;console&#39;</span><span class="p">]</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="c"># The worker process configuration is just a QueueHandler attached to the</span>
    <span class="c"># root logger, which allows all messages to be sent to the queue.</span>
    <span class="c"># We disable existing loggers to disable the &quot;setup&quot; logger used in the</span>
    <span class="c"># parent process. This is needed on POSIX because the logger will</span>
    <span class="c"># be there in the child following a fork().</span>
    <span class="n">config_worker</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">&#39;disable_existing_loggers&#39;</span><span class="p">:</span> <span class="k">True</span><span class="p">,</span>
        <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;queue&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.handlers.QueueHandler&#39;</span><span class="p">,</span>
                <span class="s">&#39;queue&#39;</span><span class="p">:</span> <span class="n">q</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
            <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;queue&#39;</span><span class="p">]</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="c"># The listener process configuration shows that the full flexibility of</span>
    <span class="c"># logging configuration is available to dispatch events to handlers however</span>
    <span class="c"># you want.</span>
    <span class="c"># We disable existing loggers to disable the &quot;setup&quot; logger used in the</span>
    <span class="c"># parent process. This is needed on POSIX because the logger will</span>
    <span class="c"># be there in the child following a fork().</span>
    <span class="n">config_listener</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">&#39;disable_existing_loggers&#39;</span><span class="p">:</span> <span class="k">True</span><span class="p">,</span>
        <span class="s">&#39;formatters&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;detailed&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.Formatter&#39;</span><span class="p">,</span>
                <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;%(asctime)s %(name)-15s %(levelname)-8s %(processName)-10s %(message)s&#39;</span>
            <span class="p">},</span>
            <span class="s">&#39;simple&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.Formatter&#39;</span><span class="p">,</span>
                <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;%(name)-15s %(levelname)-8s %(processName)-10s %(message)s&#39;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;console&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.StreamHandler&#39;</span><span class="p">,</span>
                <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;INFO&#39;</span><span class="p">,</span>
                <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;simple&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s">&#39;file&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.FileHandler&#39;</span><span class="p">,</span>
                <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="s">&#39;mplog.log&#39;</span><span class="p">,</span>
                <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
                <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;detailed&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s">&#39;foofile&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.FileHandler&#39;</span><span class="p">,</span>
                <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="s">&#39;mplog-foo.log&#39;</span><span class="p">,</span>
                <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
                <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;detailed&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s">&#39;errors&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.FileHandler&#39;</span><span class="p">,</span>
                <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="s">&#39;mplog-errors.log&#39;</span><span class="p">,</span>
                <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
                <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;ERROR&#39;</span><span class="p">,</span>
                <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;detailed&#39;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s">&#39;loggers&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;foofile&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
            <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;console&#39;</span><span class="p">,</span> <span class="s">&#39;file&#39;</span><span class="p">,</span> <span class="s">&#39;errors&#39;</span><span class="p">]</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="c"># Log some initial events, just to show that logging in the parent works</span>
    <span class="c"># normally.</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">config_initial</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;setup&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;About to create workers ...&#39;</span><span class="p">)</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker_process</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;worker %d&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                     <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">config_worker</span><span class="p">,))</span>
        <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Started worker: %s&#39;</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;About to create listener ...&#39;</span><span class="p">)</span>
    <span class="n">stop_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">listener_process</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;listener&#39;</span><span class="p">,</span>
                 <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">,</span> <span class="n">config_listener</span><span class="p">))</span>
    <span class="n">lp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Started listener&#39;</span><span class="p">)</span>
    <span class="c"># We now hang around for the workers to finish their work.</span>
    <span class="k">for</span> <span class="n">wp</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="c"># Workers all done, listening can now stop.</span>
    <span class="c"># Logging in the parent still works normally.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Telling listener to stop ...&#39;</span><span class="p">)</span>
    <span class="n">stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="n">lp</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;All done.&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="inserting-a-bom-into-messages-sent-to-a-sysloghandler">
<h2>SysLogHandler に送るメッセージに BOM を挿入する<a class="headerlink" href="#inserting-a-bom-into-messages-sent-to-a-sysloghandler" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference external" href="http://tools.ietf.org/html/rfc5424">RFC 5424</a> は syslog デーモンに Unicode メッセージを送る時、次の構造を要求しています: オプショナルなピュア ASCII部分、続けて UTF-8 の Byte Order Mark (BOM)、続けて UTF-8 でエンコードされた Unicode.
(<a class="reference external" href="http://tools.ietf.org/html/rfc5424#section-6">仕様の該当セクション</a> を参照)</p>
<p>Python 3.1 で <a class="reference internal" href="../library/logging.handlers.html#logging.handlers.SysLogHandler" title="logging.handlers.SysLogHandler"><code class="xref py py-class docutils literal"><span class="pre">SysLogHandler</span></code></a> に、 message に BOM を挿入するコードが追加されました。
しかし、そのときの実装が悪くて、 message の先頭に BOM をつけてしまうのでピュアASCII 部分をその前に書くことができませんでした。</p>
<p>この動作は壊れているので、 Python 3.2.4 以降では BOM を挿入するコードが、削除されました。
書き直されるのではなく削除されたので、 RFC 5424 準拠の、 BOM と、オプションのピュア ASCII部分をBOMの前に、任意の Unicode を BOM の後ろに持つ UTF-8 でエンコードされた message を生成したい場合、次の手順に従う必要があります:</p>
<ol class="arabic">
<li><p class="first"><a class="reference internal" href="../library/logging.handlers.html#logging.handlers.SysLogHandler" title="logging.handlers.SysLogHandler"><code class="xref py py-class docutils literal"><span class="pre">SysLogHandler</span></code></a> のインスタンスに、次のような format 文字列を持った <a class="reference internal" href="../library/logging.html#logging.Formatter" title="logging.Formatter"><code class="xref py py-class docutils literal"><span class="pre">Formatter</span></code></a> インスタンスをアタッチする:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="s">&#39;ASCII section</span><span class="se">\ufeff</span><span class="s">Unicode section&#39;</span>
</pre></div>
</div>
<p>Unicode のコードポイント U+FEFF は、 UTF-8 でエンコードすると BOM &#8211; <code class="docutils literal"><span class="pre">b'\xef\xbb\xbf'</span></code> &#8211; になります。</p>
</li>
<li><p class="first">ASCII セクションを好きなプレースホルダに変更する。ただしその部分の置換結果が常に ASCII になるように注意する。
(UTF-8 でエンコードされてもその部分が変化しないようにする。)</p>
</li>
<li><p class="first">Unicode セクションを任意のプレースホルダに置き換える。この部分を置換したデータに ASCII 外の文字が含まれていても、それは単に UTF-8 でエンコードされるだけです。</p>
</li>
</ol>
<p>フォーマットされた message は <code class="docutils literal"><span class="pre">SysLogHandler</span></code> によって UTF-8 でエンコードされます。
上のルールに従えば、 RFC 5424 準拠のメッセージを生成できます。
上のルールに従わない場合、 logging は何もエラーを起こしませんが、 message は RFC 5424 に準拠しない形で送られるので、
syslog デーモン側で何かエラーが起こる可能性があります。</p>
</div>
<div class="section" id="implementing-structured-logging">
<h2>構造化ログを実装する<a class="headerlink" href="#implementing-structured-logging" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>多くのログメッセージは人間が読むために書かれるため、機械的に処理しにくくなっていますが、場合によっては (複雑な正規表現を使ってメッセージをパースしなくても) プログラムがぱーすできる構造化されたフォーマットでメッセージを出力したい場合があります。
logging パッケージをつかってこれを簡単に実現することができます。
実現する方法は幾つもありますが、次の例は JSON を使ってイベントをシリアライズしています:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="k">class</span> <span class="nc">StructuredMessage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;%s &gt;&gt;&gt; %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">StructuredMessage</span>   <span class="c"># optional, to improve readability</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">&#39;%(message)s&#39;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;message 1&#39;</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="s">&#39;baz&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mf">123.456</span><span class="p">))</span>
</pre></div>
</div>
<p>上のスクリプトを実行すると次のように出力されます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">message</span> <span class="mi">1</span> <span class="o">&gt;&gt;&gt;</span> <span class="p">{</span><span class="s">&quot;fnum&quot;</span><span class="p">:</span> <span class="mf">123.456</span><span class="p">,</span> <span class="s">&quot;num&quot;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">:</span> <span class="s">&quot;baz&quot;</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">:</span> <span class="s">&quot;bar&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>要素の順序は Python のバージョンによって異なることに注意してください。</p>
<p>より特殊な処理が必要な場合、次の例のように、カスタムの JSON エンコーダを作ることができます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="c"># This next bit is to ensure the script runs unchanged on 2.x and 3.x</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">unicode</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Encoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;unicode_escape&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Encoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StructuredMessage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;%s &gt;&gt;&gt; %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">StructuredMessage</span>   <span class="c"># optional, to improve readability</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">&#39;%(message)s&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;message 1&#39;</span><span class="p">,</span> <span class="n">set_value</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">snowman</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\u2603</span><span class="s">&#39;</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>上のスクリプトを実行すると次のように出力されます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">message</span> <span class="mi">1</span> <span class="o">&gt;&gt;&gt;</span> <span class="p">{</span><span class="s">&quot;snowman&quot;</span><span class="p">:</span> <span class="s">&quot;</span><span class="se">\u2603</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;set_value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>
</pre></div>
</div>
<p>要素の順序は Python のバージョンによって異なることに注意してください。</p>
</div>
<div class="section" id="customizing-handlers-with-dictconfig">
<span id="custom-handlers"></span><h2>handler を <a class="reference internal" href="../library/logging.config.html#logging.config.dictConfig" title="logging.config.dictConfig"><code class="xref py py-func docutils literal"><span class="pre">dictConfig()</span></code></a> を使ってカスタマイズする<a class="headerlink" href="#customizing-handlers-with-dictconfig" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>logging handler に特定のカスタマイズを何度もしたい場合で、 <a class="reference internal" href="../library/logging.config.html#logging.config.dictConfig" title="logging.config.dictConfig"><code class="xref py py-func docutils literal"><span class="pre">dictConfig()</span></code></a> を使っているなら、サブクラスを作らなくてもカスタマイズが可能です。
例えば、ログファイルの owner を設定したいとします。
これは POSIX 環境では <a class="reference internal" href="../library/shutil.html#shutil.chown" title="shutil.chown"><code class="xref py py-func docutils literal"><span class="pre">shutil.chown()</span></code></a> を使って簡単に実現できますが、標準ライブラリの file handler はこの機能を組み込みでサポートしていません。
handler の生成を通常の関数を使ってカスタマイズすることができます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="k">def</span> <span class="nf">owned_file_handler</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">owner</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
</pre></div>
</div>
<p>そして、 <a class="reference internal" href="../library/logging.config.html#logging.config.dictConfig" title="logging.config.dictConfig"><code class="xref py py-func docutils literal"><span class="pre">dictConfig()</span></code></a> に渡される構成設定の中で、この関数を使って logging handler を生成するように指定することができます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">LOGGING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;disable_existing_loggers&#39;</span><span class="p">:</span> <span class="k">False</span><span class="p">,</span>
    <span class="s">&#39;formatters&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;%(asctime)s %(levelname)s %(name)s %(message)s&#39;</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;file&#39;</span><span class="p">:{</span>
            <span class="c"># The values below are popped from this dictionary and</span>
            <span class="c"># used to create the handler, set the handler&#39;s level and</span>
            <span class="c"># its formatter.</span>
            <span class="s">&#39;()&#39;</span><span class="p">:</span> <span class="n">owned_file_handler</span><span class="p">,</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span><span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
            <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;default&#39;</span><span class="p">,</span>
            <span class="c"># The values below are passed to the handler creator callable</span>
            <span class="c"># as keyword arguments.</span>
            <span class="s">&#39;owner&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;pulse&#39;</span><span class="p">,</span> <span class="s">&#39;pulse&#39;</span><span class="p">],</span>
            <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="s">&#39;chowntest.log&#39;</span><span class="p">,</span>
            <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
            <span class="s">&#39;encoding&#39;</span><span class="p">:</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">],</span>
        <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>この例は説明用のものですが、 owner の user と group を <code class="docutils literal"><span class="pre">pulse</span></code> に設定しています。
これを動くスクリプトに <code class="docutils literal"><span class="pre">chowntest.py</span></code> に組み込んでみます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">logging.config</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span>

<span class="k">def</span> <span class="nf">owned_file_handler</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">owner</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>

<span class="n">LOGGING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;disable_existing_loggers&#39;</span><span class="p">:</span> <span class="k">False</span><span class="p">,</span>
    <span class="s">&#39;formatters&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;%(asctime)s %(levelname)s %(name)s %(message)s&#39;</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;file&#39;</span><span class="p">:{</span>
            <span class="c"># The values below are popped from this dictionary and</span>
            <span class="c"># used to create the handler, set the handler&#39;s level and</span>
            <span class="c"># its formatter.</span>
            <span class="s">&#39;()&#39;</span><span class="p">:</span> <span class="n">owned_file_handler</span><span class="p">,</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span><span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
            <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;default&#39;</span><span class="p">,</span>
            <span class="c"># The values below are passed to the handler creator callable</span>
            <span class="c"># as keyword arguments.</span>
            <span class="s">&#39;owner&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;pulse&#39;</span><span class="p">,</span> <span class="s">&#39;pulse&#39;</span><span class="p">],</span>
            <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="s">&#39;chowntest.log&#39;</span><span class="p">,</span>
            <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
            <span class="s">&#39;encoding&#39;</span><span class="p">:</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">],</span>
        <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">LOGGING</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;mylogger&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;A debug message&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>これを実行するには、 <code class="docutils literal"><span class="pre">root</span></code> 権限で実行する必要があるかもしれません:</p>
<div class="highlight-python3"><div class="highlight"><pre>$ sudo python3.3 chowntest.py
$ cat chowntest.log
2013-11-05 09:34:51,128 DEBUG mylogger A debug message
$ ls -l chowntest.log
-rw-r--r-- 1 pulse pulse 55 2013-11-05 09:34 chowntest.log
</pre></div>
</div>
<p><a class="reference internal" href="../library/shutil.html#shutil.chown" title="shutil.chown"><code class="xref py py-func docutils literal"><span class="pre">shutil.chown()</span></code></a> が追加されたのが Python 3.3 からなので、この例は Python 3.3 を使っています。
このアプローチ自体は <a class="reference internal" href="../library/logging.config.html#logging.config.dictConfig" title="logging.config.dictConfig"><code class="xref py py-func docutils literal"><span class="pre">dictConfig()</span></code></a> をサポートした全ての Python バージョン - Python 2.7, 3.2 以降 - で利用できます。
3.3 以前のバージョンでは、オーナーを変更するのに <a class="reference internal" href="../library/os.html#os.chown" title="os.chown"><code class="xref py py-func docutils literal"><span class="pre">os.chown()</span></code></a> を利用する必要があるでしょう。</p>
<p>実際には、 handler を生成する関数はプロジェクト内のどこかにあるユーティリティモジュールに置くことになるでしょう。
設定の中で直接関数を参照する代わりに:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="s">&#39;()&#39;</span><span class="p">:</span> <span class="n">owned_file_handler</span><span class="p">,</span>
</pre></div>
</div>
<p>次のように書くこともできます:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="s">&#39;()&#39;</span><span class="p">:</span> <span class="s">&#39;ext://project.util.owned_file_handler&#39;</span><span class="p">,</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">project.util</span></code> は関数がある実際の場所に置き換えてください。
上のスクリプトでは <code class="docutils literal"><span class="pre">'ext://__main__.owned_file_handler'</span></code> で動くはずです。
<a class="reference internal" href="../library/logging.config.html#logging.config.dictConfig" title="logging.config.dictConfig"><code class="xref py py-func docutils literal"><span class="pre">dictConfig()</span></code></a> は <code class="docutils literal"><span class="pre">ext://</span></code> から実際の callable を見つけます。</p>
<p>この例は他のファイルに対する変更を実装する例にもなっています。
例えば <a class="reference internal" href="../library/os.html#os.chmod" title="os.chmod"><code class="xref py py-func docutils literal"><span class="pre">os.chmod()</span></code></a> を使って、同じ方法で POSIX パーミッションを設定できるでしょう。</p>
<p>もちろん、このアプローチは <a class="reference internal" href="../library/logging.handlers.html#logging.FileHandler" title="logging.FileHandler"><code class="xref py py-class docutils literal"><span class="pre">FileHandler</span></code></a> 以外の handler 、ローテートする file handler のいずれかやその他の handler にも適用できます。</p>
</div>
<div class="section" id="using-particular-formatting-styles-throughout-your-application">
<span id="formatting-styles"></span><h2>Using particular formatting styles throughout your application<a class="headerlink" href="#using-particular-formatting-styles-throughout-your-application" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>In Python 3.2, the <a class="reference internal" href="../library/logging.html#logging.Formatter" title="logging.Formatter"><code class="xref py py-class docutils literal"><span class="pre">Formatter</span></code></a> gained a <code class="docutils literal"><span class="pre">style</span></code> keyword
parameter which, while defaulting to <code class="docutils literal"><span class="pre">%</span></code> for backward compatibility, allowed
the specification of <code class="docutils literal"><span class="pre">{</span></code> or <code class="docutils literal"><span class="pre">$</span></code> to support the formatting approaches
supported by <a class="reference internal" href="../library/stdtypes.html#str.format" title="str.format"><code class="xref py py-meth docutils literal"><span class="pre">str.format()</span></code></a> and <a class="reference internal" href="../library/string.html#string.Template" title="string.Template"><code class="xref py py-class docutils literal"><span class="pre">string.Template</span></code></a>. Note that this
governs the formatting of logging messages for final output to logs, and is
completely orthogonal to how an individual logging message is constructed.</p>
<p>Logging calls (<a class="reference internal" href="../library/logging.html#logging.Logger.debug" title="logging.Logger.debug"><code class="xref py py-meth docutils literal"><span class="pre">debug()</span></code></a>, <a class="reference internal" href="../library/logging.html#logging.Logger.info" title="logging.Logger.info"><code class="xref py py-meth docutils literal"><span class="pre">info()</span></code></a> etc.) only take
positional parameters for the actual logging message itself, with keyword
parameters used only for determining options for how to handle the logging call
(e.g. the <code class="docutils literal"><span class="pre">exc_info</span></code> keyword parameter to indicate that traceback information
should be logged, or the <code class="docutils literal"><span class="pre">extra</span></code> keyword parameter to indicate additional
contextual information to be added to the log). So you cannot directly make
logging calls using <a class="reference internal" href="../library/stdtypes.html#str.format" title="str.format"><code class="xref py py-meth docutils literal"><span class="pre">str.format()</span></code></a> or <a class="reference internal" href="../library/string.html#string.Template" title="string.Template"><code class="xref py py-class docutils literal"><span class="pre">string.Template</span></code></a> syntax,
because internally the logging package uses %-formatting to merge the format
string and the variable arguments. There would no changing this while preserving
backward compatibility, since all logging calls which are out there in existing
code will be using %-format strings.</p>
<p>There have been suggestions to associate format styles with specific loggers,
but that approach also runs into backward compatibility problems because any
existing code could be using a given logger name and using %-formatting.</p>
<p>For logging to work interoperably between any third-party libraries and your
code, decisions about formatting need to be made at the level of the
individual logging call. This opens up a couple of ways in which alternative
formatting styles can be accommodated.</p>
<div class="section" id="using-logrecord-factories">
<h3>Using LogRecord factories<a class="headerlink" href="#using-logrecord-factories" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>In Python 3.2, along with the <a class="reference internal" href="../library/logging.html#logging.Formatter" title="logging.Formatter"><code class="xref py py-class docutils literal"><span class="pre">Formatter</span></code></a> changes mentioned
above, the logging package gained the ability to allow users to set their own
<a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a> subclasses, using the <a class="reference internal" href="../library/logging.html#logging.setLogRecordFactory" title="logging.setLogRecordFactory"><code class="xref py py-func docutils literal"><span class="pre">setLogRecordFactory()</span></code></a> function.
You can use this to set your own subclass of <a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a>, which does the
Right Thing by overriding the <a class="reference internal" href="../library/logging.html#logging.LogRecord.getMessage" title="logging.LogRecord.getMessage"><code class="xref py py-meth docutils literal"><span class="pre">getMessage()</span></code></a> method. The base
class implementation of this method is where the <code class="docutils literal"><span class="pre">msg</span> <span class="pre">%</span> <span class="pre">args</span></code> formatting
happens, and where you can substitute your alternate formatting; however, you
should be careful to support all formatting styles and allow %-formatting as
the default, to ensure interoperability with other code. Care should also be
taken to call <code class="docutils literal"><span class="pre">str(self.msg)</span></code>, just as the base implementation does.</p>
<p>Refer to the reference documentation on <a class="reference internal" href="../library/logging.html#logging.setLogRecordFactory" title="logging.setLogRecordFactory"><code class="xref py py-func docutils literal"><span class="pre">setLogRecordFactory()</span></code></a> and
<a class="reference internal" href="../library/logging.html#logging.LogRecord" title="logging.LogRecord"><code class="xref py py-class docutils literal"><span class="pre">LogRecord</span></code></a> for more information.</p>
</div>
<div class="section" id="using-custom-message-objects">
<h3>Using custom message objects<a class="headerlink" href="#using-custom-message-objects" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>There is another, perhaps simpler way that you can use {}- and $- formatting to
construct your individual log messages. You may recall (from
<a class="reference internal" href="logging.html#arbitrary-object-messages"><span>任意のオブジェクトをメッセージに使用する</span></a>) that when logging you can use an arbitrary
object as a message format string, and that the logging package will call
<a class="reference internal" href="../library/stdtypes.html#str" title="str"><code class="xref py py-func docutils literal"><span class="pre">str()</span></code></a> on that object to get the actual format string. Consider the
following two classes:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="k">class</span> <span class="nc">BraceMessage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DollarMessage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">string</span> <span class="k">import</span> <span class="n">Template</span>
        <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>Either of these can be used in place of a format string, to allow {}- or
$-formatting to be used to build the actual &#8220;message&#8221; part which appears in the
formatted log output in place of “%(message)s” or “{message}” or “$message”.
If you find it a little unwieldy to use the class names whenever you want to log
something, you can make it more palatable if you use an alias such as <code class="docutils literal"><span class="pre">M</span></code> or
<code class="docutils literal"><span class="pre">_</span></code> for the message (or perhaps <code class="docutils literal"><span class="pre">__</span></code>, if you are using <code class="docutils literal"><span class="pre">_</span></code> for
localization).</p>
<p>Examples of this approach are given below. Firstly, formatting with
<a class="reference internal" href="../library/stdtypes.html#str.format" title="str.format"><code class="xref py py-meth docutils literal"><span class="pre">str.format()</span></code></a>:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">__</span> <span class="o">=</span> <span class="n">BraceMessage</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">__</span><span class="p">(</span><span class="s">&#39;Message with {0} {1}&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;placeholders&#39;</span><span class="p">))</span>
<span class="go">Message with 2 placeholders</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">:</span> <span class="k">pass</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">__</span><span class="p">(</span><span class="s">&#39;Message with coordinates: ({point.x:.2f}, {point.y:.2f})&#39;</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">p</span><span class="p">))</span>
<span class="go">Message with coordinates: (0.50, 0.50)</span>
</pre></div>
</div>
<p>Secondly, formatting with <a class="reference internal" href="../library/string.html#string.Template" title="string.Template"><code class="xref py py-class docutils literal"><span class="pre">string.Template</span></code></a>:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">__</span> <span class="o">=</span> <span class="n">DollarMessage</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">__</span><span class="p">(</span><span class="s">&#39;Message with $num $what&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s">&#39;placeholders&#39;</span><span class="p">))</span>
<span class="go">Message with 2 placeholders</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>One thing to note is that you pay no significant performance penalty with this
approach: the actual formatting happens not when you make the logging call, but
when (and if) the logged message is actually about to be output to a log by a
handler. So the only slightly unusual thing which might trip you up is that the
parentheses go around the format string and the arguments, not just the format
string. That’s because the __ notation is just syntax sugar for a constructor
call to one of the <code class="docutils literal"><span class="pre">XXXMessage</span></code> classes shown above.</p>
</div>
</div>
<div class="section" id="configuring-filters-with-dictconfig">
<span id="filters-dictconfig"></span><h2>Configuring filters with <a class="reference internal" href="../library/logging.config.html#logging.config.dictConfig" title="logging.config.dictConfig"><code class="xref py py-func docutils literal"><span class="pre">dictConfig()</span></code></a><a class="headerlink" href="#configuring-filters-with-dictconfig" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>You <em>can</em> configure filters using <a class="reference internal" href="../library/logging.config.html#logging.config.dictConfig" title="logging.config.dictConfig"><code class="xref py py-func docutils literal"><span class="pre">dictConfig()</span></code></a>, though it
might not be obvious at first glance how to do it (hence this recipe). Since
<a class="reference internal" href="../library/logging.html#logging.Filter" title="logging.Filter"><code class="xref py py-class docutils literal"><span class="pre">Filter</span></code></a> is the only filter class included in the standard
library, and it is unlikely to cater to many requirements (it&#8217;s only there as a
base class), you will typically need to define your own <a class="reference internal" href="../library/logging.html#logging.Filter" title="logging.Filter"><code class="xref py py-class docutils literal"><span class="pre">Filter</span></code></a>
subclass with an overridden <a class="reference internal" href="../library/logging.html#logging.Filter.filter" title="logging.Filter.filter"><code class="xref py py-meth docutils literal"><span class="pre">filter()</span></code></a> method. To do this,
specify the <code class="docutils literal"><span class="pre">()</span></code> key in the configuration dictionary for the filter,
specifying a callable which will be used to create the filter (a class is the
most obvious, but you can provide any callable which returns a
<a class="reference internal" href="../library/logging.html#logging.Filter" title="logging.Filter"><code class="xref py py-class docutils literal"><span class="pre">Filter</span></code></a> instance). Here is a complete example:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.config</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">MyFilter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Filter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">allow</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">msg</span>
        <span class="k">if</span> <span class="n">allow</span><span class="p">:</span>
            <span class="n">record</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;changed: &#39;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="n">msg</span>
        <span class="k">return</span> <span class="n">allow</span>

<span class="n">LOGGING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;filters&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;myfilter&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;()&#39;</span><span class="p">:</span> <span class="n">MyFilter</span><span class="p">,</span>
            <span class="s">&#39;param&#39;</span><span class="p">:</span> <span class="s">&#39;noshow&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;console&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.StreamHandler&#39;</span><span class="p">,</span>
            <span class="s">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;myfilter&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;DEBUG&#39;</span><span class="p">,</span>
        <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;console&#39;</span><span class="p">]</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">LOGGING</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;hello - noshow&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This example shows how you can pass configuration data to the callable which
constructs the instance, in the form of keyword parameters. When run, the above
script will print:</p>
<div class="highlight-python3"><div class="highlight"><pre><span class="n">changed</span><span class="p">:</span> <span class="n">hello</span>
</pre></div>
</div>
<p>which shows that the filter is working as configured.</p>
<p>A couple of extra points to note:</p>
<ul class="simple">
<li>If you can&#8217;t refer to the callable directly in the configuration (e.g. if it
lives in a different module, and you can&#8217;t import it directly where the
configuration dictionary is), you can use the form <code class="docutils literal"><span class="pre">ext://...</span></code> as described
in <a class="reference internal" href="../library/logging.config.html#logging-config-dict-externalobj"><span>外部オブジェクトへのアクセス</span></a>. For example, you could have used
the text <code class="docutils literal"><span class="pre">'ext://__main__.MyFilter'</span></code> instead of <code class="docutils literal"><span class="pre">MyFilter</span></code> in the above
example.</li>
<li>As well as for filters, this technique can also be used to configure custom
handlers and formatters. See <a class="reference internal" href="../library/logging.config.html#logging-config-dict-userdef"><span>ユーザ定義オブジェクト</span></a> for more
information on how logging supports using user-defined objects in its
configuration, and see the other cookbook recipe <a class="reference internal" href="#custom-handlers"><span>handler を dictConfig() を使ってカスタマイズする</span></a> above.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../contents.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">Logging クックブック</a><ul>
<li><a class="reference internal" href="#using-logging-in-multiple-modules">複数のモジュールで logging を使う</a></li>
<li><a class="reference internal" href="#multiple-handlers-and-formatters">複数の handler と formatter</a></li>
<li><a class="reference internal" href="#logging-to-multiple-destinations">複数の出力先にログを出力する</a></li>
<li><a class="reference internal" href="#configuration-server-example">設定サーバの例</a></li>
<li><a class="reference internal" href="#dealing-with-handlers-that-block">ブロックする handler を扱う</a></li>
<li><a class="reference internal" href="#sending-and-receiving-logging-events-across-a-network">ネットワーク越しの logging イベントの送受信</a></li>
<li><a class="reference internal" href="#adding-contextual-information-to-your-logging-output">コンテキスト情報をログ記録出力に付加する</a><ul>
<li><a class="reference internal" href="#using-loggeradapters-to-impart-contextual-information">LoggerAdapter を使ったコンテキスト情報の伝達</a><ul>
<li><a class="reference internal" href="#using-objects-other-than-dicts-to-pass-contextual-information">コンテキスト情報を渡すために dict 以外のオブジェクトを使う</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-filters-to-impart-contextual-information">Filter を使ったコンテキスト情報の伝達</a></li>
</ul>
</li>
<li><a class="reference internal" href="#logging-to-a-single-file-from-multiple-processes">複数のプロセスからの単一ファイルへのログ記録</a></li>
<li><a class="reference internal" href="#using-file-rotation">ファイルをローテートする</a></li>
<li><a class="reference internal" href="#use-of-alternative-formatting-styles">別の format スタイルを利用する</a></li>
<li><a class="reference internal" href="#customizing-logrecord"><code class="docutils literal"><span class="pre">LogRecord</span></code> のカスタマイズ</a></li>
<li><a class="reference internal" href="#subclassing-queuehandler-a-zeromq-example">QueueHandler を継承する - ZeroMQ を使う例</a></li>
<li><a class="reference internal" href="#subclassing-queuelistener-a-zeromq-example">QueueListener のサブクラスを作る - ZeroMQ を使う例</a></li>
<li><a class="reference internal" href="#an-example-dictionary-based-configuration">辞書ベースで構成する例</a></li>
<li><a class="reference internal" href="#using-a-rotator-and-namer-to-customize-log-rotation-processing">rotator と namer を使ってログローテートをカスタマイズする</a></li>
<li><a class="reference internal" href="#a-more-elaborate-multiprocessing-example">より手の込んだ multiprocessing の例</a></li>
<li><a class="reference internal" href="#inserting-a-bom-into-messages-sent-to-a-sysloghandler">SysLogHandler に送るメッセージに BOM を挿入する</a></li>
<li><a class="reference internal" href="#implementing-structured-logging">構造化ログを実装する</a></li>
<li><a class="reference internal" href="#customizing-handlers-with-dictconfig">handler を <code class="docutils literal"><span class="pre">dictConfig()</span></code> を使ってカスタマイズする</a></li>
<li><a class="reference internal" href="#using-particular-formatting-styles-throughout-your-application">Using particular formatting styles throughout your application</a><ul>
<li><a class="reference internal" href="#using-logrecord-factories">Using LogRecord factories</a></li>
<li><a class="reference internal" href="#using-custom-message-objects">Using custom message objects</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuring-filters-with-dictconfig">Configuring filters with <code class="docutils literal"><span class="pre">dictConfig()</span></code></a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="logging.html"
                        title="前の章へ">Logging HOWTO</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="regex.html"
                        title="次の章へ">正規表現 HOWTO</a></p>
<h3>このページ</h3>
<ul class="this-page-menu">
  <li><a href="../bugs.html">Report a Bug</a></li>
  <li><a href="../_sources/howto/logging-cookbook.txt"
         rel="nofollow">Show Source</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    モジュール、クラス、または関数名を入力してください
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="regex.html" title="正規表現 HOWTO"
             >次へ</a> |</li>
        <li class="right" >
          <a href="logging.html" title="Logging HOWTO"
             >前へ</a> |</li>
        <li><img src="../_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="http://www.python.org/">Python</a> &raquo;</li>
        <li>
          <span class="version_switcher_placeholder">3.3.6</span>
          <a href="../index.html">Documentation</a> &raquo;
        </li>

          <li class="nav-item nav-item-1"><a href="index.html" >Python HOWTO</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    &copy; <a href="../copyright.html">Copyright</a> 1990-2015, Python Software Foundation.
    <br />
    The Python Software Foundation is a non-profit corporation.
    <a href="http://www.python.org/psf/donations/">Please donate.</a>
    <br />
    Last updated on Dec 28, 2015.
    <a href="../bugs.html">Found a bug</a>?
    <br />
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
    <br />
    <a href="https://github.com/python-doc-ja/python-doc-ja">Pythonドキュメント日本語翻訳プロジェクト</a>
    によって翻訳されました。
    <a href="https://github.com/python-doc-ja/python-doc-ja/issues">誤訳を報告する。</a>
    </div>

  </body>
</html>